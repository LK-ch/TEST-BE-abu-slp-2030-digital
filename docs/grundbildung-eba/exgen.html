<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABU Aufgabengenerator - EBA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #fff;
            padding: 30px 20px;
            text-align: center;
            margin-bottom: 40px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #0066cc;
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1em;
        }
        
        .stepper-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .stepper-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }
        
        .stepper-header::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50px;
            right: 50px;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .step.active .step-circle {
            background: #0066cc;
        }
        
        .step.completed .step-circle {
            background: #4caf50;
        }
        
        .step-label {
            font-size: 0.85em;
            color: #666;
            text-align: center;
            max-width: 100px;
        }
        
        .step-content {
            min-height: 400px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        select, input, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #0066cc;
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: flex-start;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .checkbox-item:hover {
            background: #e9ecef;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            margin-top: 2px;
        }
        
        .checkbox-item label {
            margin-bottom: 0;
            cursor: pointer;
            font-weight: normal;
        }
        
        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        button {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #0066cc;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0052a3;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        
        .btn-generate {
            background: #4caf50;
            color: white;
        }
        
        .btn-generate:hover {
            background: #45a049;
        }
        
        .generated-content {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .generated-content h3 {
            color: #0066cc;
            margin-bottom: 15px;
        }
        
        .summary-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-container h2 {
            color: #0066cc;
            margin-bottom: 20px;
        }
        
        .summary-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .summary-section h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0066cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            display: none;
        }
        
        .error-message.active {
            display: block;
        }
        
        @media print {
            .button-group, .stepper-header {
                display: none;
            }
            
            .summary-container {
                box-shadow: none;
            }
        }
        
        @media (max-width: 768px) {
            .stepper-header {
                flex-wrap: wrap;
            }
            
            .step-label {
                font-size: 0.75em;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üéØ ABU Aufgabengenerator</h1>
            <p class="subtitle">KI-gest√ºtztes Tool zur Erstellung von kompetenzorientierten Aufgaben f√ºr die 2-j√§hrige Grundbildung EBA</p>
        </div>
    </header>

    <main class="container">
        <div class="stepper-container">
            <div class="stepper-header">
                <div class="step active" id="step-1-header">
                    <div class="step-circle">1</div>
                    <span class="step-label">Thema w√§hlen</span>
                </div>
                <div class="step" id="step-2-header">
                    <div class="step-circle">2</div>
                    <span class="step-label">Lebensbezug</span>
                </div>
                <div class="step" id="step-3-header">
                    <div class="step-circle">3</div>
                    <span class="step-label">Lerninhalt</span>
                </div>
                <div class="step" id="step-4-header">
                    <div class="step-circle">4</div>
                    <span class="step-label">Kompetenzen</span>
                </div>
                <div class="step" id="step-5-header">
                    <div class="step-circle">5</div>
                    <span class="step-label">Herausforderung</span>
                </div>
                <div class="step" id="step-6-header">
                    <div class="step-circle">6</div>
                    <span class="step-label">Lernprodukt</span>
                </div>
                <div class="step" id="step-7-header">
                    <div class="step-circle">7</div>
                    <span class="step-label">Zusammenfassung</span>
                </div>
            </div>

            <!-- Step 1: Thema w√§hlen -->
            <div class="step-content" id="step-1">
                <h2>Schritt 1: Thema ausw√§hlen</h2>
                <div class="form-group">
                    <label for="schuljahr">Schuljahr:</label>
                    <select id="schuljahr">
                        <option value="">Bitte w√§hlen...</option>
                        <option value="1">1. Lehrjahr</option>
                        <option value="2">2. Lehrjahr</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="thema">Thema:</label>
                    <select id="thema" disabled>
                        <option value="">Zuerst Schuljahr w√§hlen...</option>
                    </select>
                </div>
            </div>

            <!-- Step 2: Lebensbezug -->
            <div class="step-content" id="step-2" style="display: none;">
                <h2>Schritt 2: Individuellen Lebensbezug w√§hlen</h2>
                <div class="form-group">
                    <label for="lebensbezug">Lebensbezug:</label>
                    <select id="lebensbezug">
                        <option value="">Bitte w√§hlen...</option>
                    </select>
                </div>
            </div>

            <!-- Step 3: Lerninhalt -->
            <div class="step-content" id="step-3" style="display: none;">
                <h2>Schritt 3: Lerninhalt definieren</h2>
                <div class="form-group">
                    <label for="lerninhalt">Lerninhalt:</label>
                    <select id="lerninhalt">
                        <option value="">Bitte w√§hlen...</option>
                    </select>
                </div>
            </div>

            <!-- Step 4: Kompetenzen -->
            <div class="step-content" id="step-4" style="display: none;">
                <h2>Schritt 4: Kompetenzen ausw√§hlen</h2>
                <p style="color: #666; margin-bottom: 20px;">W√§hlen Sie mindestens eine Kompetenz aus jeder Kategorie:</p>
                
                <div class="form-group">
                    <label>Schl√ºsselkompetenzen (mind. 1):</label>
                    <div class="checkbox-group" id="schluesselkompetenzen">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                </div>

                <div class="form-group">
                    <label>Sprachmodi (mind. 1):</label>
                    <div class="checkbox-group" id="sprachmodi">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                </div>

                <div class="form-group">
                    <label>Digitale Kompetenzen (mind. 1):</label>
                    <div class="checkbox-group" id="digitale-kompetenzen">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                </div>

                <div class="form-group">
                    <label>Handlungsfelder/Aspekte (mind. 1):</label>
                    <div class="checkbox-group" id="handlungsfelder">
                        <!-- Wird dynamisch gef√ºllt -->
                    </div>
                </div>
            </div>

            <!-- Step 5: Herausforderung -->
            <div class="step-content" id="step-5" style="display: none;">
                <h2>Schritt 5: Herausforderung formulieren</h2>
                
                <div class="loading" id="loading-herausforderung">
                    <div class="spinner"></div>
                    <p>KI generiert Vorschl√§ge...</p>
                </div>
                
                <div class="error-message" id="error-herausforderung"></div>
                
                <div class="generated-content" id="generated-herausforderung" style="display: none;">
                    <h3>KI-Vorschlag:</h3>
                    <p id="herausforderung-text"></p>
                    <div style="margin-top: 15px;">
                        <button type="button" class="btn-generate" onclick="generateHerausforderung()">
                            üîÑ Neuen Vorschlag generieren
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="custom-herausforderung">Eigene Herausforderung formulieren (optional):</label>
                    <textarea id="custom-herausforderung" placeholder="Formulieren Sie hier Ihre eigene Herausforderung..."></textarea>
                </div>
            </div>

            <!-- Step 6: Lernprodukt -->
            <div class="step-content" id="step-6" style="display: none;">
                <h2>Schritt 6: Lernprodukt und Bewertung definieren</h2>
                
                <div class="loading" id="loading-lernprodukt">
                    <div class="spinner"></div>
                    <p>KI erstellt Aufgabenstellung...</p>
                </div>
                
                <div class="error-message" id="error-lernprodukt"></div>
                
                <div class="generated-content" id="generated-lernprodukt" style="display: none;">
                    <h3>KI-generierte Aufgabe:</h3>
                    <div id="lernprodukt-content"></div>
                    <div style="margin-top: 15px;">
                        <button type="button" class="btn-generate" onclick="generateLernprodukt()">
                            üîÑ Neue Aufgabe generieren
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="custom-lernprodukt">Eigene Aufgabenstellung (optional):</label>
                    <textarea id="custom-lernprodukt" placeholder="Formulieren Sie hier Ihre eigene Aufgabenstellung..." style="min-height: 200px;"></textarea>
                </div>
            </div>

            <!-- Step 7: Zusammenfassung -->
            <div class="step-content" id="step-7" style="display: none;">
                <div class="summary-container">
                    <h2>üìã Zusammenfassung der Aufgabe</h2>
                    
                    <div class="summary-section">
                        <h4>Grunddaten:</h4>
                        <div id="summary-basic"></div>
                    </div>
                    
                    <div class="summary-section">
                        <h4>Ausgew√§hlte Kompetenzen:</h4>
                        <div id="summary-kompetenzen"></div>
                    </div>
                    
                    <div class="summary-section">
                        <h4>Herausforderung:</h4>
                        <div id="summary-herausforderung"></div>
                    </div>
                    
                    <div class="summary-section">
                        <h4>Lernprodukt und Bewertung:</h4>
                        <div id="summary-lernprodukt"></div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button type="button" class="btn-primary" onclick="window.print()">
                            üñ®Ô∏è Aufgabe drucken
                        </button>
                        <button type="button" class="btn-generate" onclick="saveAsJSON()">
                            üíæ Als JSON speichern
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation buttons -->
            <div class="button-group">
                <button type="button" class="btn-secondary" id="btn-back" onclick="previousStep()" style="display: none;">
                    ‚Üê Zur√ºck
                </button>
                <button type="button" class="btn-primary" id="btn-next" onclick="nextStep()">
                    Weiter ‚Üí
                </button>
            </div>
        </div>
    </main>

    <script>
        // Themen-Datenstruktur (vereinfacht f√ºr Demo)
        const themenData = {
            "1": {
                "1": {
                    titel: "Ins Berufsleben einsteigen",
                    lektionen: 22,
                    lebensbezuege: {
                        "1": {
                            titel: "Ich finde mich im Betrieb und in der Berufsfachschule zurecht",
                            lerninhalte: {
                                "1": {
                                    titel: "Ich orientiere mich in der Arbeits- und Ausbildungswelt",
                                    schluesselkompetenzen: [
                                        "3.2.2 Sich selbst Ziele setzen",
                                        "3.2.8 Lebensphasen planen",
                                        "3.2.10 Sich in ver√§nderndem Umfeld zurechtfinden"
                                    ],
                                    sprachmodi: [
                                        "4.2.1.1 Rezeption m√ºndlich",
                                        "4.2.1.2 Rezeption audiovisuell",
                                        "4.2.1.3 Rezeption schriftlich",
                                        "4.2.2.2 Produktion schriftlich",
                                        "4.2.3.1 Interaktion m√ºndlich",
                                        "4.2.3.3 Interaktion digital"
                                    ],
                                    digitaleKompetenzen: [
                                        "ICT-Tools einrichten",
                                        "Suchfunktion nutzen",
                                        "KI f√ºr Internetsuche verwenden"
                                    ],
                                    handlungsfelder: [
                                        "5.2.6.3 Recht - Juristische Informationen",
                                        "5.2.2.3 Identit√§t - Pers√∂nliche Entscheidungen"
                                    ]
                                }
                            }
                        },
                        "2": {
                            titel: "Ich kommuniziere auf konstruktive Art und Weise",
                            lerninhalte: {
                                "1": {
                                    titel: "Ich kann mich situationsgerecht und respektvoll ausdr√ºcken",
                                    schluesselkompetenzen: [
                                        "3.2.6 Standpunkte begr√ºnden",
                                        "3.2.7 Unterschiedliche Standpunkte nachvollziehen"
                                    ],
                                    sprachmodi: [
                                        "4.2.2.1 Produktion m√ºndlich",
                                        "4.2.3.1 Interaktion m√ºndlich"
                                    ],
                                    digitaleKompetenzen: [
                                        "KI-Chat f√ºr Dialoge nutzen",
                                        "Office-Programme anwenden"
                                    ],
                                    handlungsfelder: [
                                        "5.2.1.1 Ethik - Empathisch handeln"
                                    ]
                                }
                            }
                        }
                    }
                },
                "2": {
                    titel: "Bewusst konsumieren und handeln",
                    lektionen: 22,
                    lebensbezuege: {
                        "1": {
                            titel: "Ich gehe verantwortungsbewusst mit meinem Geld um",
                            lerninhalte: {
                                "1": {
                                    titel: "Ich kann ein Budget erstellen",
                                    schluesselkompetenzen: [
                                        "3.2.2 Sich selbst Ziele setzen",
                                        "3.2.6 Standpunkte begr√ºnden"
                                    ],
                                    sprachmodi: [
                                        "4.2.2.2 Produktion schriftlich"
                                    ],
                                    digitaleKompetenzen: [
                                        "Excel-Tabellen bedienen",
                                        "Digitale Budgethilfen finden"
                                    ],
                                    handlungsfelder: [
                                        "5.2.8.1 Wirtschaft - Als Konsument handeln"
                                    ]
                                }
                            }
                        }
                    }
                }
            },
            "2": {
                "3": {
                    titel: "Risiko und Sicherheit",
                    lektionen: 22,
                    lebensbezuege: {
                        "1": {
                            titel: "Ich kann Risiken einsch√§tzen und mich absichern",
                            lerninhalte: {
                                "1": {
                                    titel: "Ich erkenne Risiken im Alltag und Beruf",
                                    schluesselkompetenzen: [
                                        "3.2.1 Zwischen relevanten und irrelevanten Quellen unterscheiden",
                                        "3.2.8 Lebensphasen planen"
                                    ],
                                    sprachmodi: [
                                        "4.2.1.1 Rezeption m√ºndlich",
                                        "4.2.2.2 Produktion schriftlich"
                                    ],
                                    digitaleKompetenzen: [
                                        "Digitale Pr√§sentationsformen nutzen",
                                        "KI f√ºr √úberarbeitungen nutzen"
                                    ],
                                    handlungsfelder: [
                                        "5.2.2.2 Identit√§t - Auf Gesundheit achten",
                                        "5.2.8.2 Wirtschaft - Wirtschaftliche Lage einsch√§tzen"
                                    ]
                                }
                            }
                        }
                    }
                }
            }
        };

        let currentStep = 1;
        let formData = {
            schuljahr: '',
            thema: '',
            lebensbezug: '',
            lerninhalt: '',
            kompetenzen: {
                schluessel: [],
                sprache: [],
                digital: [],
                handlungsfelder: []
            },
            herausforderung: '',
            lernprodukt: ''
        };

        // Event Listeners
        document.getElementById('schuljahr').addEventListener('change', function(e) {
            const schuljahr = e.target.value;
            formData.schuljahr = schuljahr;
            
            const themaSelect = document.getElementById('thema');
            themaSelect.innerHTML = '<option value="">Bitte w√§hlen...</option>';
            themaSelect.disabled = !schuljahr;
            
            if (schuljahr && themenData[schuljahr]) {
                Object.keys(themenData[schuljahr]).forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `Thema ${key}: ${themenData[schuljahr][key].titel} (${themenData[schuljahr][key].lektionen} Lektionen)`;
                    themaSelect.appendChild(option);
                });
            }
        });

        document.getElementById('thema').addEventListener('change', function(e) {
            formData.thema = e.target.value;
        });

        function nextStep() {
            if (validateCurrentStep()) {
                if (currentStep === 4) {
                    // Nach Kompetenzauswahl: Herausforderung generieren
                    generateHerausforderung();
                } else if (currentStep === 5) {
                    // Nach Herausforderung: Lernprodukt generieren
                    generateLernprodukt();
                } else if (currentStep === 6) {
                    // Zur Zusammenfassung
                    showSummary();
                }
                
                if (currentStep < 7) {
                    document.getElementById(`step-${currentStep}`).style.display = 'none';
                    document.getElementById(`step-${currentStep}-header`).classList.remove('active');
                    document.getElementById(`step-${currentStep}-header`).classList.add('completed');
                    
                    currentStep++;
                    
                    document.getElementById(`step-${currentStep}`).style.display = 'block';
                    document.getElementById(`step-${currentStep}-header`).classList.add('active');
                    
                    updateStepContent();
                    updateButtons();
                }
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                document.getElementById(`step-${currentStep}`).style.display = 'none';
                document.getElementById(`step-${currentStep}-header`).classList.remove('active');
                
                currentStep--;
                
                document.getElementById(`step-${currentStep}`).style.display = 'block';
                document.getElementById(`step-${currentStep}-header`).classList.remove('completed');
                document.getElementById(`step-${currentStep}-header`).classList.add('active');
                
                updateButtons();
            }
        }

        function updateButtons() {
            const backBtn = document.getElementById('btn-back');
            const nextBtn = document.getElementById('btn-next');
            
            backBtn.style.display = currentStep > 1 ? 'block' : 'none';
            
            if (currentStep === 7) {
                nextBtn.style.display = 'none';
            } else {
                nextBtn.style.display = 'block';
                nextBtn.textContent = currentStep === 6 ? 'Zusammenfassung ‚Üí' : 'Weiter ‚Üí';
            }
        }

        function validateCurrentStep() {
            switch(currentStep) {
                case 1:
                    if (!formData.schuljahr || !formData.thema) {
                        alert('Bitte w√§hlen Sie Schuljahr und Thema aus.');
                        return false;
                    }
                    break;
                case 2:
                    if (!formData.lebensbezug) {
                        alert('Bitte w√§hlen Sie einen Lebensbezug aus.');
                        return false;
                    }
                    break;
                case 3:
                    if (!formData.lerninhalt) {
                        alert('Bitte w√§hlen Sie einen Lerninhalt aus.');
                        return false;
                    }
                    break;
                case 4:
                    const checkedSchluessel = document.querySelectorAll('#schluesselkompetenzen input:checked').length;
                    const checkedSprache = document.querySelectorAll('#sprachmodi input:checked').length;
                    const checkedDigital = document.querySelectorAll('#digitale-kompetenzen input:checked').length;
                    const checkedHandlung = document.querySelectorAll('#handlungsfelder input:checked').length;
                    
                    if (checkedSchluessel === 0 || checkedSprache === 0 || 
                        checkedDigital === 0 || checkedHandlung === 0) {
                        alert('Bitte w√§hlen Sie mindestens eine Kompetenz aus jeder Kategorie.');
                        return false;
                    }
                    
                    // Speichere ausgew√§hlte Kompetenzen
                    formData.kompetenzen.schluessel = Array.from(document.querySelectorAll('#schluesselkompetenzen input:checked'))
                        .map(cb => cb.value);
                    formData.kompetenzen.sprache = Array.from(document.querySelectorAll('#sprachmodi input:checked'))
                        .map(cb => cb.value);
                    formData.kompetenzen.digital = Array.from(document.querySelectorAll('#digitale-kompetenzen input:checked'))
                        .map(cb => cb.value);
                    formData.kompetenzen.handlungsfelder = Array.from(document.querySelectorAll('#handlungsfelder input:checked'))
                        .map(cb => cb.value);
                    break;
                case 5:
                    const customHerausforderung = document.getElementById('custom-herausforderung').value;
                    const generatedHerausforderung = document.getElementById('herausforderung-text').textContent;
                    
                    formData.herausforderung = customHerausforderung || generatedHerausforderung;
                    
                    if (!formData.herausforderung) {
                        alert('Bitte warten Sie auf den KI-Vorschlag oder formulieren Sie eine eigene Herausforderung.');
                        return false;
                    }
                    break;
                case 6:
                    const customLernprodukt = document.getElementById('custom-lernprodukt').value;
                    const generatedLernprodukt = document.getElementById('lernprodukt-content').innerHTML;
                    
                    formData.lernprodukt = customLernprodukt || generatedLernprodukt;
                    
                    if (!formData.lernprodukt) {
                        alert('Bitte warten Sie auf die KI-generierte Aufgabe oder formulieren Sie eine eigene.');
                        return false;
                    }
                    break;
            }
            return true;
        }

        function updateStepContent() {
            const thema = themenData[formData.schuljahr]?.[formData.thema];
            
            switch(currentStep) {
                case 2:
                    // Lebensbez√ºge laden
                    const lebensbezugSelect = document.getElementById('lebensbezug');
                    lebensbezugSelect.innerHTML = '<option value="">Bitte w√§hlen...</option>';
                    
                    if (thema?.lebensbezuege) {
                        Object.keys(thema.lebensbezuege).forEach(key => {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = thema.lebensbezuege[key].titel;
                            lebensbezugSelect.appendChild(option);
                        });
                    }
                    
                    lebensbezugSelect.addEventListener('change', (e) => {
                        formData.lebensbezug = e.target.value;
                    });
                    break;
                    
                case 3:
                    // Lerninhalte laden
                    const lerninhaltSelect = document.getElementById('lerninhalt');
                    lerninhaltSelect.innerHTML = '<option value="">Bitte w√§hlen...</option>';
                    
                    const lebensbezug = thema?.lebensbezuege?.[formData.lebensbezug];
                    if (lebensbezug?.lerninhalte) {
                        Object.keys(lebensbezug.lerninhalte).forEach(key => {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = lebensbezug.lerninhalte[key].titel;
                            lerninhaltSelect.appendChild(option);
                        });
                    }
                    
                    lerninhaltSelect.addEventListener('change', (e) => {
                        formData.lerninhalt = e.target.value;
                    });
                    break;
                    
                case 4:
                    // Kompetenzen laden
                    const lerninhalt = thema?.lebensbezuege?.[formData.lebensbezug]?.lerninhalte?.[formData.lerninhalt];
                    
                    if (lerninhalt) {
                        // Schl√ºsselkompetenzen
                        const schluesselContainer = document.getElementById('schluesselkompetenzen');
                        schluesselContainer.innerHTML = '';
                        lerninhalt.schluesselkompetenzen.forEach(komp => {
                            schluesselContainer.innerHTML += `
                                <div class="checkbox-item">
                                    <input type="checkbox" id="sk-${komp}" value="${komp}">
                                    <label for="sk-${komp}">${komp}</label>
                                </div>
                            `;
                        });
                        
                        // Sprachmodi
                        const sprachContainer = document.getElementById('sprachmodi');
                        sprachContainer.innerHTML = '';
                        lerninhalt.sprachmodi.forEach(modus => {
                            sprachContainer.innerHTML += `
                                <div class="checkbox-item">
                                    <input type="checkbox" id="sm-${modus}" value="${modus}">
                                    <label for="sm-${modus}">${modus}</label>
                                </div>
                            `;
                        });
                        
                        // Digitale Kompetenzen
                        const digitalContainer = document.getElementById('digitale-kompetenzen');
                        digitalContainer.innerHTML = '';
                        lerninhalt.digitaleKompetenzen.forEach(komp => {
                            digitalContainer.innerHTML += `
                                <div class="checkbox-item">
                                    <input type="checkbox" id="dk-${komp}" value="${komp}">
                                    <label for="dk-${komp}">${komp}</label>
                                </div>
                            `;
                        });
                        
                        // Handlungsfelder
                        const handlungsContainer = document.getElementById('handlungsfelder');
                        handlungsContainer.innerHTML = '';
                        lerninhalt.handlungsfelder.forEach(feld => {
                            handlungsContainer.innerHTML += `
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hf-${feld}" value="${feld}">
                                    <label for="hf-${feld}">${feld}</label>
                                </div>
                            `;
                        });
                    }
                    break;
            }
        }

        async function generateHerausforderung() {
            const loadingDiv = document.getElementById('loading-herausforderung');
            const errorDiv = document.getElementById('error-herausforderung');
            const generatedDiv = document.getElementById('generated-herausforderung');
            
            loadingDiv.classList.add('active');
            errorDiv.classList.remove('active');
            generatedDiv.style.display = 'none';
            
            try {
                // API-Aufruf √ºber Cloudflare Worker
                const response = await fetch('https://your-worker.your-subdomain.workers.dev/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'herausforderung',
                        context: {
                            thema: themenData[formData.schuljahr][formData.thema].titel,
                            lebensbezug: themenData[formData.schuljahr][formData.thema].lebensbezuege[formData.lebensbezug].titel,
                            lerninhalt: themenData[formData.schuljahr][formData.thema].lebensbezuege[formData.lebensbezug].lerninhalte[formData.lerninhalt].titel,
                            kompetenzen: formData.kompetenzen
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('herausforderung-text').textContent = data.herausforderung;
                    generatedDiv.style.display = 'block';
                } else {
                    throw new Error(data.error || 'Unbekannter Fehler');
                }
            } catch (error) {
                // Fallback f√ºr Demo
                const demoHerausforderung = `Als neue/r Lernende/r stehe ich vor der Herausforderung, mich in der komplexen Welt der beruflichen Grundbildung zurechtzufinden. Ich muss verstehen, welche Dokumente wichtig sind, wie ich mit offiziellen Schreiben umgehe und wo ich bei Unklarheiten Unterst√ºtzung finde. Diese Aufgabe hilft mir, selbstst√§ndig und verantwortungsbewusst mit formellen Anforderungen umzugehen.`;
                
                document.getElementById('herausforderung-text').textContent = demoHerausforderung;
                generatedDiv.style.display = 'block';
            } finally {
                loadingDiv.classList.remove('active');
            }
        }

        async function generateLernprodukt() {
            const loadingDiv = document.getElementById('loading-lernprodukt');
            const errorDiv = document.getElementById('error-lernprodukt');
            const generatedDiv = document.getElementById('generated-lernprodukt');
            
            loadingDiv.classList.add('active');
            errorDiv.classList.remove('active');
            generatedDiv.style.display = 'none';
            
            try {
                // API-Aufruf √ºber Cloudflare Worker
                const response = await fetch('https://your-worker.your-subdomain.workers.dev/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: 'lernprodukt',
                        context: {
                            herausforderung: formData.herausforderung,
                            kompetenzen: formData.kompetenzen
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('lernprodukt-content').innerHTML = data.lernprodukt;
                    generatedDiv.style.display = 'block';
                } else {
                    throw new Error(data.error || 'Unbekannter Fehler');
                }
            } catch (error) {
                // Fallback f√ºr Demo
                const demoLernprodukt = `
                    <h4>Aufgabenstellung:</h4>
                    <p>Erstellen Sie eine pers√∂nliche Dokumentenmappe mit folgenden Elementen:</p>
                    <ol>
                        <li>Analysieren Sie drei offizielle Dokumente aus Ihrem Ausbildungsalltag (z.B. Lehrvertrag, Hausordnung, √úK-Aufgebot)</li>
                        <li>Markieren Sie die wichtigsten Informationen und erstellen Sie eine √úbersicht</li>
                        <li>Formulieren Sie zu einem Dokument eine schriftliche R√ºckfrage per E-Mail</li>
                        <li>Dokumentieren Sie Ihre Lernerkenntnisse in einem kurzen Reflexionstext</li>
                    </ol>
                    
                    <h4>Bewertungskriterien:</h4>
                    <table style="width: 100%; margin-top: 15px;">
                        <tr style="background: #f0f0f0;">
                            <th style="padding: 10px; text-align: left;">Kriterium</th>
                            <th style="padding: 10px; text-align: left;">Punkte</th>
                        </tr>
                        <tr>
                            <td style="padding: 10px;">Vollst√§ndigkeit der Dokumentenmappe</td>
                            <td style="padding: 10px;">20</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;">Qualit√§t der Markierungen und √úbersicht</td>
                            <td style="padding: 10px;">25</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;">Sprachliche Korrektheit der E-Mail</td>
                            <td style="padding: 10px;">25</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;">Reflexionstiefe und Erkenntnisse</td>
                            <td style="padding: 10px;">20</td>
                        </tr>
                        <tr>
                            <td style="padding: 10px;">Einsatz digitaler Werkzeuge</td>
                            <td style="padding: 10px;">10</td>
                        </tr>
                        <tr style="background: #f0f0f0; font-weight: bold;">
                            <td style="padding: 10px;">Gesamt</td>
                            <td style="padding: 10px;">100</td>
                        </tr>
                    </table>
                `;
                
                document.getElementById('lernprodukt-content').innerHTML = demoLernprodukt;
                generatedDiv.style.display = 'block';
            } finally {
                loadingDiv.classList.remove('active');
            }
        }

        function showSummary() {
            const thema = themenData[formData.schuljahr][formData.thema];
            const lebensbezug = thema.lebensbezuege[formData.lebensbezug];
            const lerninhalt = lebensbezug.lerninhalte[formData.lerninhalt];
            
            // Grunddaten
            document.getElementById('summary-basic').innerHTML = `
                <p><strong>Schuljahr:</strong> ${formData.schuljahr}. Lehrjahr</p>
                <p><strong>Thema:</strong> ${thema.titel}</p>
                <p><strong>Lebensbezug:</strong> ${lebensbezug.titel}</p>
                <p><strong>Lerninhalt:</strong> ${lerninhalt.titel}</p>
            `;
            
            // Kompetenzen
            document.getElementById('summary-kompetenzen').innerHTML = `
                <p><strong>Schl√ºsselkompetenzen:</strong></p>
                <ul>${formData.kompetenzen.schluessel.map(k => `<li>${k}</li>`).join('')}</ul>
                <p><strong>Sprachmodi:</strong></p>
                <ul>${formData.kompetenzen.sprache.map(k => `<li>${k}</li>`).join('')}</ul>
                <p><strong>Digitale Kompetenzen:</strong></p>
                <ul>${formData.kompetenzen.digital.map(k => `<li>${k}</li>`).join('')}</ul>
                <p><strong>Handlungsfelder:</strong></p>
                <ul>${formData.kompetenzen.handlungsfelder.map(k => `<li>${k}</li>`).join('')}</ul>
            `;
            
            // Herausforderung
            document.getElementById('summary-herausforderung').innerHTML = `
                <p>${formData.herausforderung}</p>
            `;
            
            // Lernprodukt
            document.getElementById('summary-lernprodukt').innerHTML = formData.lernprodukt;
        }

        function saveAsJSON() {
            const dataStr = JSON.stringify(formData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `ABU-Aufgabe-${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
    </script>
</body>
</html>
