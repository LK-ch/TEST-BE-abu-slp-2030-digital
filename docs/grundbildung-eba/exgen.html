<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üéì ABU Aufgabengenerator EBA</title>
  <style>
    /* --- Reset & Basics --- */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f5f5f5;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    /* --- Header (an Index-Design angelehnt) --- */
    header {
      background:#fff; padding:40px 20px; text-align:center; margin-bottom:40px;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color:#0066cc; font-size:2.2em; margin-bottom:10px; font-weight:600; }
    .subtitle { color:#666; font-size:1.05em; max-width:900px; margin:0 auto; }

    /* --- Card/Panel (wei√ü/blau) --- */
    .panel {
      background:#fff; border-radius:10px; padding:30px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08); margin-bottom:24px;
      border-left:4px solid #0066cc;
    }

    /* --- Stepper --- */
    .stepper-header {
      display:flex; justify-content:space-between; align-items:center;
      gap:12px; margin-bottom:24px; position:relative;
    }
    .stepper-header::before {
      content:""; position:absolute; left:60px; right:60px; top:25px; height:2px; background:#e9ecef;
    }
    .step { display:flex; flex-direction:column; align-items:center; z-index:1; cursor:pointer; }
    .step-circle {
      width:46px; height:46px; border-radius:50%; background:#e0e0e0; color:#fff;
      display:flex; align-items:center; justify-content:center; font-weight:700;
      box-shadow:0 2px 10px rgba(0,0,0,0.06); transition:all .25s;
    }
    .step-label { margin-top:8px; font-size:.9em; color:#6c757d; transition:color .25s; }
    .step.active .step-circle { background:#0066cc; transform:scale(1.05); }
    .step.active .step-label { color:#0066cc; font-weight:600; }
    .step.completed .step-circle { background:#21a366; }
    .step.completed .step-label { color:#21a366; }

    .step-content { display:block; min-height:420px; }
    .info-box {
      background: #f8fbff; border-left:4px solid #0066cc; padding:14px; border-radius:8px; margin:14px 0 18px;
      color:#495057; font-size:.95em;
    }

    /* --- Forms --- */
    .form-group { margin-bottom:22px; }
    label {
      display:block; margin-bottom:8px; color:#495057; font-weight:600; font-size:.9em;
      text-transform:uppercase; letter-spacing:.3px;
    }
    select, input, textarea {
      width:100%; padding:12px 14px; border:2px solid #e9ecef; border-radius:10px; font-size:1em; background:#fff;
      transition: all .2s ease;
    }
    select:focus, input:focus, textarea:focus { outline:none; border-color:#0066cc; box-shadow:0 0 0 4px rgba(0,102,204,.08); }
    textarea { min-height:140px; resize:vertical; }

    /* --- Checkbox Grid --- */
    .checkbox-group { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:12px; }
    .checkbox-item {
      display:flex; align-items:flex-start; gap:10px; padding:12px; border-radius:10px; background:#f8f9fa; border:2px solid transparent;
      transition: all .2s ease; cursor:pointer;
    }
    .checkbox-item:hover { background:#eef2f6; }
    .checkbox-item input[type="checkbox"] { width:18px; height:18px; margin-top:2px; cursor:pointer; }
    .checkbox-item:has(input:checked) { background:#f0f7ff; border-color:#0066cc; }
    .checkbox-item label { flex:1; margin:0; color:#495057; cursor:pointer; }

    .competence-category { margin-bottom:18px; background:#fff; border:1px solid #edf2f7; border-radius:10px; padding:16px; }
    .competence-category h5 { color:#0066cc; margin-bottom:10px; font-size:1.05em; font-weight:600; display:flex; gap:8px; align-items:center; }
    .competence-category h5::before {
      content:'‚úì'; width:22px; height:22px; border-radius:50%; background:#0066cc; color:#fff;
      display:inline-flex; align-items:center; justify-content:center; font-size:.8em;
    }

    /* --- Buttons --- */
    .button-group { display:flex; justify-content:space-between; margin-top:24px; padding-top:20px; border-top:1px solid #e9ecef; }
    button {
      padding:12px 26px; border:none; border-radius:10px; font-size:1em; cursor:pointer; font-weight:600;
      box-shadow:0 2px 10px rgba(0,0,0,0.06); transition: transform .15s, box-shadow .2s;
      text-transform:uppercase; letter-spacing:.3px;
    }
    button:hover { transform: translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,0.12); }
    .btn-primary { background:#0066cc; color:#fff; }
    .btn-secondary { background:#f0f2f5; color:#333; }
    .btn-generate { background:#21a366; color:#fff; }

    /* --- Generated --- */
    .generated-content {
      background:#f8fbff; border:2px solid rgba(0,102,204,.18); border-radius:10px; padding:20px; margin:18px 0;
    }
    .generated-content h3 { color:#0066cc; margin-bottom:10px; }

    /* --- Loading & Error --- */
    .loading { display:none; text-align:center; padding:18px; }
    .loading.active { display:block; }
    .spinner {
      border:3px solid rgba(0,102,204,.15); border-top:3px solid #0066cc; border-radius:50%; width:46px; height:46px;
      animation: spin 1s linear infinite; margin:0 auto 10px;
    }
    @keyframes spin { 0% {transform:rotate(0)} 100% {transform:rotate(360deg)} }
    .error-message { display:none; background:#ffeef0; color:#c62828; padding:14px; border-left:4px solid #c62828; border-radius:8px; margin:12px 0; }
    .error-message.active { display:block; }

    /* --- Summary --- */
    .summary-container { background:#fff; border-radius:10px; padding:28px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
    .summary-container h2 { color:#0066cc; margin-bottom:16px; }
    .summary-section {
      margin-bottom:18px; padding:16px; background:#f8fbff; border-left:4px solid #0066cc; border-radius:8px;
    }
    .badge { display:inline-block; padding:4px 10px; background:#0066cc; color:#fff; border-radius:20px; font-size:.85em; font-weight:600; }

    @media (max-width: 860px) {
      .stepper-header { flex-wrap:wrap; gap:14px; }
      .stepper-header::before { display:none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>ABU Aufgabengenerator EBA</h1>
      <p class="subtitle">Kompetenzorientierte Aufgaben mit KI erstellen ‚Äì abgest√ºtzt auf deine ausgew√§hlten Kompetenzen und Lehrplan-Texte.</p>
    </div>
  </header>

  <main class="container">
    <div class="panel">
      <!-- Stepper Header -->
      <div class="stepper-header">
        <div class="step active" id="step-1-header"><div class="step-circle">1</div><span class="step-label">Schuljahr</span></div>
        <div class="step" id="step-2-header"><div class="step-circle">2</div><span class="step-label">Thema</span></div>
        <div class="step" id="step-3-header"><div class="step-circle">3</div><span class="step-label">Lebensbezug</span></div>
        <div class="step" id="step-4-header"><div class="step-circle">4</div><span class="step-label">Lerninhalt</span></div>
        <div class="step" id="step-5-header"><div class="step-circle">5</div><span class="step-label">Kompetenzen</span></div>
        <div class="step" id="step-6-header"><div class="step-circle">6</div><span class="step-label">Herausforderung</span></div>
        <div class="step" id="step-7-header"><div class="step-circle">7</div><span class="step-label">Lernprodukt</span></div>
        <div class="step" id="step-8-header"><div class="step-circle">8</div><span class="step-label">Zusammenfassung</span></div>
      </div>

      <!-- Steps -->
      <div class="step-content" id="step-1">
        <h2>Schritt 1: Schuljahr w√§hlen</h2>
        <div class="info-box"><p>W√§hlen Sie das entsprechende Lehrjahr aus. Jedes Lehrjahr umfasst vier thematische Schwerpunkte.</p></div>
        <div class="form-group">
          <label for="schuljahr">Schuljahr</label>
          <select id="schuljahr">
            <option value="">Bitte w√§hlen‚Ä¶</option>
            <option value="1">1. Lehrjahr (Themen 1‚Äì4)</option>
            <option value="2">2. Lehrjahr (Themen 5‚Äì8)</option>
          </select>
        </div>
      </div>

      <div class="step-content" id="step-2" style="display:none;">
        <h2>Schritt 2: Thema ausw√§hlen</h2>
        <div class="info-box"><p>Jedes Thema behandelt einen spezifischen Lebensbereich mit konkreten Herausforderungen und Kompetenzen.</p></div>
        <div class="form-group">
          <label for="thema">Thema</label>
          <select id="thema" disabled>
            <option value="">Zuerst Schuljahr w√§hlen‚Ä¶</option>
          </select>
        </div>
      </div>

      <div class="step-content" id="step-3" style="display:none;">
        <h2>Schritt 3: Individuellen Lebensbezug w√§hlen</h2>
        <div class="info-box"><p>Der Lebensbezug verankert das Thema in der Lebenswelt der Lernenden.</p></div>
        <div class="form-group">
          <label for="lebensbezug">Lebensbezug</label>
          <select id="lebensbezug">
            <option value="">Bitte w√§hlen‚Ä¶</option>
          </select>
        </div>
      </div>

      <div class="step-content" id="step-4" style="display:none;">
        <h2>Schritt 4: Lerninhalt definieren</h2>
        <div class="info-box"><p>Der Lerninhalt konkretisiert, was die Lernenden erarbeiten und k√∂nnen sollen.</p></div>
        <div class="form-group">
          <label for="lerninhalt">Lerninhalt</label>
          <select id="lerninhalt">
            <option value="">Bitte w√§hlen‚Ä¶</option>
          </select>
        </div>
      </div>

      <div class="step-content" id="step-5" style="display:none;">
        <h2>Schritt 5: Kompetenzen ausw√§hlen</h2>
        <div class="info-box"><p>W√§hlen Sie aus jeder Kategorie mindestens eine Kompetenz. Die Auswahl steuert die KI-Ausgaben.</p></div>

        <div class="competence-category">
          <h5>Sprachmodi</h5>
          <div class="checkbox-group" id="sprachmodi"></div>
        </div>
        <div class="competence-category">
          <h5>Schl√ºsselkompetenzen</h5>
          <div class="checkbox-group" id="schluesselkompetenzen"></div>
        </div>
        <div class="competence-category">
          <h5>Digitale Kompetenzen</h5>
          <div class="checkbox-group" id="digitale-kompetenzen"></div>
        </div>
        <div class="competence-category">
          <h5>Gesellschaftliche Handlungsfelder</h5>
          <div class="checkbox-group" id="handlungsfelder"></div>
        </div>
      </div>

      <div class="step-content" id="step-6" style="display:none;">
        <h2>Schritt 6: Herausforderung formulieren</h2>
        <div class="info-box"><p>Die KI generiert zuerst eine Herausforderung (Ich-Form, 3‚Äì4 S√§tze). Sie k√∂nnen sie danach √ºberarbeiten.</p></div>

        <div class="loading" id="loading-herausforderung">
          <div class="spinner"></div>
          <p>KI generiert Herausforderung‚Ä¶</p>
        </div>
        <div class="error-message" id="error-herausforderung"></div>

        <div class="generated-content" id="generated-herausforderung" style="display:none;">
          <h3>ü§ñ KI-generierte Herausforderung</h3>
          <p id="herausforderung-text"></p>
          <div style="margin-top:14px;">
            <button type="button" class="btn-generate" onclick="generateHerausforderung()">üîÑ Neu generieren</button>
          </div>
        </div>

        <div class="form-group" style="margin-top:14px;">
          <label for="custom-herausforderung">Eigene/√ºberarbeitete Herausforderung (optional)</label>
          <textarea id="custom-herausforderung" placeholder="Hier eigene Formulierung eintragen‚Ä¶"></textarea>
        </div>
      </div>

      <div class="step-content" id="step-7" style="display:none;">
        <h2>Schritt 7: Lernprodukt & Bewertung</h2>
        <div class="info-box">
          <p>Die KI erzeugt Aufgabenstellung, Arbeitsschritte, Bewertungsraster (100 Punkte), Beispiel sowie Zirkularit√§ts-Kommentar (vorher/danach).</p>
        </div>

        <div class="loading" id="loading-lernprodukt">
          <div class="spinner"></div>
          <p>KI erstellt Aufgabenstellung‚Ä¶</p>
        </div>
        <div class="error-message" id="error-lernprodukt"></div>

        <div class="generated-content" id="generated-lernprodukt" style="display:none;">
          <h3>üéØ KI-generierte Aufgabe</h3>
          <div id="lernprodukt-content"></div>

          <h4 style="margin-top:16px;">‚ôªÔ∏è Zirkularit√§t</h4>
          <div id="zirkulaere-kompetenzen"><em>Wird im Abschnitt ‚ÄûZirkularit√§t (vorher / danach)‚Äú erl√§utert.</em></div>

          <div style="margin-top:14px;">
            <button type="button" class="btn-generate" onclick="generateLernprodukt()">üîÑ Neu generieren</button>
          </div>
        </div>

        <div class="form-group" style="margin-top:14px;">
          <label for="custom-lernprodukt">Eigene Aufgabenstellung (optional)</label>
          <textarea id="custom-lernprodukt" placeholder="Hier eigenst√§ndig anpassen/√ºbernehmen‚Ä¶" style="min-height:200px;"></textarea>
        </div>
      </div>

      <div class="step-content" id="step-8" style="display:none;">
        <div class="summary-container">
          <h2>üìã Aufgabenzusammenfassung</h2>
          <div class="summary-section"><h4>Grundinformationen</h4><div id="summary-basic"></div></div>
          <div class="summary-section"><h4>Ausgew√§hlte Kompetenzen</h4><div id="summary-kompetenzen"></div></div>
          <div class="summary-section"><h4>Herausforderung</h4><div id="summary-herausforderung"></div></div>
          <div class="summary-section"><h4>Lernprodukt & Bewertung</h4><div id="summary-lernprodukt"></div></div>
          <div class="summary-section"><h4>Scaffolds</h4><div id="summary-scaffolds"></div></div>
          <div class="summary-section"><h4>Kompetenzaufbau (Zirkularit√§t)</h4><div id="summary-zirkularitaet"></div></div>

          <div style="margin-top:18px; text-align:center;">
            <button type="button" class="btn-primary" onclick="window.print()">üñ®Ô∏è Drucken</button>
            <button type="button" class="btn-generate" onclick="saveAsJSON()">üíæ Als JSON speichern</button>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <div class="button-group">
        <button type="button" class="btn-secondary" id="btn-back" onclick="previousStep()" style="display:none;">‚Üê Zur√ºck</button>
        <button type="button" class="btn-primary" id="btn-next" onclick="nextStep()">Weiter ‚Üí</button>
      </div>
    </div>
  </main>

  <script>
    /* --------------------------- CONFIG --------------------------- */
    // üëâ Deine Cloudflare-Worker-URL einsetzen:
    const WORKER_URL = "https://<DEIN-WORKER>.workers.dev";

    /* ----------------------- Datenmodell (kurz) ------------------- */
    // Hinweis: themenData kannst du hier (gek√ºrzt) oder extern belassen.
    // F√ºr die Demo verwende deine vorhandene Struktur ‚Äì hier nur Platzhalter:
    const themenData = window.themenData || {}; // Falls du sie extern einbindest

    let currentStep = 1;
    let formData = {
      schuljahr: '',
      thema: '',
      lebensbezug: '',
      lerninhalt: '',
      kompetenzen: { sprachmodi: [], schluessel: [], digital: [], handlungsfelder: [] },
      herausforderung: '',
      lernprodukt: '',
      scaffolds: [],
      zirkularitaet: ''
    };

    /* ----------------------- Helper-Logik ------------------------- */
    function getThemaIndex() {
      const sj = parseInt(formData.schuljahr, 10);
      const t  = parseInt(formData.thema, 10);
      if (!Number.isFinite(sj) || !Number.isFinite(t)) return null;
      return sj === 1 ? t : 4 + t; // 1..4 oder 5..8
    }
    function buildContext() {
      const th = themenData[formData.schuljahr]?.[formData.thema];
      const lb = th?.lebensbezuege?.[formData.lebensbezug];
      const li = lb?.lerninhalte?.[formData.lerninhalt];
      return {
        thema: th?.titel || "",
        thema_index: getThemaIndex(),
        lebensbezug: lb?.titel || "",
        lerninhalt: li?.titel || "",
        kompetenzen: [
          ...(formData.kompetenzen.sprachmodi || []),
          ...(formData.kompetenzen.schluessel || []),
          ...(formData.kompetenzen.digital || []),
          ...(formData.kompetenzen.handlungsfelder || [])
        ],
        frage: "Zirkularit√§t beachten: vorher/nachher?"
      };
    }
    async function callWorker(type, context) {
      const res = await fetch(WORKER_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ type, context })
      });
      if (!res.ok) {
        const t = await res.text().catch(()=> "");
        throw new Error(`Worker-Fehler ${res.status}: ${t || res.statusText}`);
      }
      const data = await res.json();
      return data[type];
    }

    /* ---------------------- UI Navigation ------------------------- */
    document.getElementById('schuljahr').addEventListener('change', (e) => {
      formData.schuljahr = e.target.value;
      const themaSelect = document.getElementById('thema');
      themaSelect.innerHTML = '<option value="">Bitte w√§hlen‚Ä¶</option>';
      themaSelect.disabled = !formData.schuljahr;
      if (formData.schuljahr && themenData[formData.schuljahr]) {
        Object.keys(themenData[formData.schuljahr]).forEach(key => {
          const opt = document.createElement('option');
          opt.value = key;
          const thema = themenData[formData.schuljahr][key];
          opt.textContent = `Thema ${key}: ${thema.titel}`;
          themaSelect.appendChild(opt);
        });
      }
    });
    document.getElementById('thema').addEventListener('change', (e) => {
      formData.thema = e.target.value;
    });

    function nextStep() {
      if (validateCurrentStep()) {
        if (currentStep === 5) generateHerausforderung();
        else if (currentStep === 6) generateLernprodukt();
        else if (currentStep === 7) showSummary();

        if (currentStep < 8) {
          document.getElementById(`step-${currentStep}`).style.display = 'none';
          document.getElementById(`step-${currentStep}-header`).classList.remove('active');
          document.getElementById(`step-${currentStep}-header`).classList.add('completed');
          currentStep++;
          document.getElementById(`step-${currentStep}`).style.display = 'block';
          document.getElementById(`step-${currentStep}-header`).classList.add('active');
          updateStepContent();
          updateButtons();
        }
      }
    }
    function previousStep() {
      if (currentStep > 1) {
        document.getElementById(`step-${currentStep}`).style.display = 'none';
        document.getElementById(`step-${currentStep}-header`).classList.remove('active');
        currentStep--;
        document.getElementById(`step-${currentStep}`).style.display = 'block';
        document.getElementById(`step-${currentStep}-header`).classList.remove('completed');
        document.getElementById(`step-${currentStep}-header`).classList.add('active');
        updateButtons();
      }
    }
    function updateButtons() {
      const backBtn = document.getElementById('btn-back');
      const nextBtn = document.getElementById('btn-next');
      backBtn.style.display = currentStep > 1 ? 'block' : 'none';
      if (currentStep === 8) nextBtn.style.display = 'none';
      else { nextBtn.style.display = 'block'; nextBtn.textContent = currentStep === 7 ? 'Zusammenfassung ‚Üí' : 'Weiter ‚Üí'; }
    }

    function validateCurrentStep() {
      switch (currentStep) {
        case 1:
          if (!formData.schuljahr) return alert('Bitte Schuljahr w√§hlen.'), false;
          break;
        case 2:
          if (!formData.thema) return alert('Bitte Thema w√§hlen.'), false;
          break;
        case 3:
          if (!formData.lebensbezug) return alert('Bitte Lebensbezug w√§hlen.'), false;
          break;
        case 4:
          if (!formData.lerninhalt) return alert('Bitte Lerninhalt w√§hlen.'), false;
          break;
        case 5: {
          const cS = document.querySelectorAll('#sprachmodi input:checked').length;
          const cK = document.querySelectorAll('#schluesselkompetenzen input:checked').length;
          const cD = document.querySelectorAll('#digitale-kompetenzen input:checked').length;
          const cH = document.querySelectorAll('#handlungsfelder input:checked').length;
          if (!cS || !cK || !cD || !cH) return alert('Bitte mind. eine Kompetenz pro Kategorie w√§hlen.'), false;

          formData.kompetenzen.sprachmodi = [...document.querySelectorAll('#sprachmodi input:checked')].map(cb => cb.value);
          formData.kompetenzen.schluessel  = [...document.querySelectorAll('#schluesselkompetenzen input:checked')].map(cb => cb.value);
          formData.kompetenzen.digital     = [...document.querySelectorAll('#digitale-kompetenzen input:checked')].map(cb => cb.value);
          formData.kompetenzen.handlungsfelder = [...document.querySelectorAll('#handlungsfelder input:checked')].map(cb => cb.value);
          break;
        }
        case 6: {
          const custom = document.getElementById('custom-herausforderung').value.trim();
          const gen    = document.getElementById('herausforderung-text').textContent.trim();
          formData.herausforderung = custom || gen;
          if (!formData.herausforderung) return alert('Bitte Herausforderung generieren/erfassen.'), false;
          break;
        }
        case 7: {
          const custom = document.getElementById('custom-lernprodukt').value.trim();
          const gen    = document.getElementById('lernprodukt-content').innerHTML.trim();
          formData.lernprodukt = custom || gen;
          if (!formData.lernprodukt) return alert('Bitte Aufgabe generieren/erfassen.'), false;
          break;
        }
      }
      return true;
    }

    function updateStepContent() {
      const thema = themenData[formData.schuljahr]?.[formData.thema];
      switch (currentStep) {
        case 3: {
          const sel = document.getElementById('lebensbezug');
          sel.innerHTML = '<option value="">Bitte w√§hlen‚Ä¶</option>';
          if (thema?.lebensbezuege) {
            Object.keys(thema.lebensbezuege).forEach(k => {
              const o = document.createElement('option');
              o.value = k; o.textContent = thema.lebensbezuege[k].titel;
              sel.appendChild(o);
            });
          }
          sel.onchange = (e)=> formData.lebensbezug = e.target.value;
          break;
        }
        case 4: {
          const sel = document.getElementById('lerninhalt');
          sel.innerHTML = '<option value="">Bitte w√§hlen‚Ä¶</option>';
          const lb = thema?.lebensbezuege?.[formData.lebensbezug];
          if (lb?.lerninhalte) {
            Object.keys(lb.lerninhalte).forEach(k => {
              const o = document.createElement('option');
              o.value = k; o.textContent = lb.lerninhalte[k].titel;
              sel.appendChild(o);
            });
          }
          sel.onchange = (e)=> formData.lerninhalt = e.target.value;
          break;
        }
        case 5: {
          const li = themenData[formData.schuljahr]?.[formData.thema]?.lebensbezuege?.[formData.lebensbezug]?.lerninhalte?.[formData.lerninhalt];
          if (!li) return;
          const renderChecks = (containerId, arr) => {
            const c = document.getElementById(containerId); c.innerHTML = '';
            (arr || []).forEach(val => {
              const id = `${containerId}-${val}`.replace(/\s+/g,'-');
              c.innerHTML += `
                <div class="checkbox-item">
                  <input type="checkbox" id="${id}" value="${val}"/>
                  <label for="${id}">${val}</label>
                </div>`;
            });
          };
          renderChecks('sprachmodi', li.sprachmodi || []);
          renderChecks('schluesselkompetenzen', li.schluesselkompetenzen || []);
          renderChecks('digitale-kompetenzen', li.digitaleKompetenzen || []);
          renderChecks('handlungsfelder', li.handlungsfelder || []);
          formData.scaffolds = li.scaffolds || [];
          break;
        }
      }
    }

    /* ------------------- KI-Generierung (Worker) ------------------ */
    async function generateHerausforderung() {
      const loading = document.getElementById('loading-herausforderung');
      const error   = document.getElementById('error-herausforderung');
      const panel   = document.getElementById('generated-herausforderung');
      loading.classList.add('active'); error.classList.remove('active'); panel.style.display='none';
      try {
        const text = await callWorker("herausforderung", buildContext());
        document.getElementById('herausforderung-text').textContent = text || '';
        panel.style.display = 'block';
      } catch (e) {
        console.error(e); error.textContent = 'Fehler beim Generieren: ' + e.message; error.classList.add('active');
      } finally { loading.classList.remove('active'); }
    }

    async function generateLernprodukt() {
      const loading = document.getElementById('loading-lernprodukt');
      const error   = document.getElementById('error-lernprodukt');
      const panel   = document.getElementById('generated-lernprodukt');
      loading.classList.add('active'); error.classList.remove('active'); panel.style.display='none';
      try {
        const ctx = buildContext();
        const confirmed = document.getElementById('custom-herausforderung').value.trim()
                        || document.getElementById('herausforderung-text').textContent.trim();
        ctx.herausforderung = confirmed || '';
        const html = await callWorker("lernprodukt_full", ctx);
        document.getElementById('lernprodukt-content').innerHTML = html || '';
        document.getElementById('zirkulaere-kompetenzen').innerHTML =
          `<em>Siehe Abschnitt ‚ÄûZirkularit√§t (vorher / danach)‚Äú in der Aufgabe.</em>`;
        formData.lernprodukt   = html || '';
        formData.zirkularitaet = document.getElementById('zirkulaere-kompetenzen').innerHTML;
        panel.style.display = 'block';
      } catch (e) {
        console.error(e); error.textContent = 'Fehler beim Generieren: ' + e.message; error.classList.add('active');
      } finally { loading.classList.remove('active'); }
    }

    /* ------------------------- Summary ---------------------------- */
    function showSummary() {
      const th = themenData[formData.schuljahr]?.[formData.thema];
      const lb = th?.lebensbezuege?.[formData.lebensbezug];
      const li = lb?.lerninhalte?.[formData.lerninhalt];

      document.getElementById('summary-basic').innerHTML = `
        <p><strong>Schuljahr:</strong> <span class="badge">${formData.schuljahr}. Lehrjahr</span></p>
        <p><strong>Thema:</strong> ${th?.titel || '-'}</p>
        <p><strong>Lebensbezug:</strong> ${lb?.titel || '-'}</p>
        <p><strong>Lerninhalt:</strong> ${li?.titel || '-'}</p>
      `;
      document.getElementById('summary-kompetenzen').innerHTML = `
        <div style="display:grid; gap:12px;">
          <div><strong>Sprachmodi:</strong><ul style="margin-top:6px;">${formData.kompetenzen.sprachmodi.map(x=>`<li>${x}</li>`).join('')}</ul></div>
          <div><strong>Schl√ºsselkompetenzen:</strong><ul style="margin-top:6px;">${formData.kompetenzen.schluessel.map(x=>`<li>${x}</li>`).join('')}</ul></div>
          <div><strong>Digitale Kompetenzen:</strong><ul style="margin-top:6px;">${formData.kompetenzen.digital.map(x=>`<li>${x}</li>`).join('')}</ul></div>
          <div><strong>Handlungsfelder:</strong><ul style="margin-top:6px;">${formData.kompetenzen.handlungsfelder.map(x=>`<li>${x}</li>`).join('')}</ul></div>
        </div>`;
      document.getElementById('summary-herausforderung').innerHTML =
        `<div style="background:#f8f9fa; padding:12px; border-radius:8px;">${formData.herausforderung || '-'}</div>`;
      document.getElementById('summary-lernprodukt').innerHTML = formData.lernprodukt || '-';
      document.getElementById('summary-scaffolds').innerHTML = `<ul>${(formData.scaffolds||[]).map(s=>`<li>${s}</li>`).join('')}</ul>`;
      document.getElementById('summary-zirkularitaet').innerHTML = formData.zirkularitaet || '<p>Siehe Zirkularit√§t im Lernprodukt.</p>';
    }

    function saveAsJSON() {
      const exportData = {
        ...formData,
        metadata: { erstellt: new Date().toISOString(), tool:"ABU Aufgabengenerator EBA", version:"1.0" }
      };
      const dataStr = JSON.stringify(exportData, null, 2);
      const uri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      const fname = `ABU-Aufgabe-${formData.schuljahr}-${formData.thema}-${new Date().toISOString().slice(0,10)}.json`;
      const link = document.createElement('a'); link.setAttribute('href', uri); link.setAttribute('download', fname); link.click();
    }

    /* ----------------------- Initialisieren ----------------------- */
    document.addEventListener('DOMContentLoaded', () => {
      updateButtons();
      // Falls du themenData extern h√§ltst, entferne diese Zeile; ansonsten hier laden.
      if (!Object.keys(themenData).length) {
        console.warn('themenData ist leer ‚Äì bitte Datenstruktur einf√ºgen/inkludieren.');
      }
    });
  </script>
</body>
</html>
