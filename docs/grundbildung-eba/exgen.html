<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLP EBA Umsetzungsvarianten-Generator</title>
    <style>
        :root {
            --zh-blue: #0F05A0; --zh-blue-light: #3A30C2; --zh-blue-lighter: #E8E6FF; --zh-white: #FFFFFF; --zh-gray-light: #F5F5F5; --zh-gray: #E0E0E0; --zh-gray-dark: #666666; --zh-success: #28A745; --zh-warning: #FFC107; --zh-danger: #DC3545; --border-radius: 8px; --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, var(--zh-blue-lighter) 0%, var(--zh-white) 100%); min-height: 100vh; color: #333; }
        .header { background: var(--zh-blue); color: var(--zh-white); padding: 1.5rem; box-shadow: var(--shadow); }
        .header h1 { font-size: 1.8rem; font-weight: 600; margin-bottom: 0.5rem; }
        .header p { opacity: 0.9; font-size: 0.95rem; }
        .progress-container { background: var(--zh-white); padding: 1rem 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .progress-bar { height: 8px; background: var(--zh-gray); border-radius: 4px; overflow: hidden; margin-top: 0.5rem; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--zh-blue) 0%, var(--zh-blue-light) 100%); width: 0%; transition: width 0.3s ease; }
        .progress-text { font-size: 0.9rem; color: var(--zh-gray-dark); margin-bottom: 0.5rem; }
        .container { display: flex; gap: 1.5rem; padding: 1.5rem; max-width: 1600px; margin: 0 auto; min-height: calc(100vh - 250px); }
        .wizard-column { flex: 1; background: var(--zh-white); border-radius: var(--border-radius); box-shadow: var(--shadow); overflow-y: auto; padding: 1.5rem; max-height: calc(100vh - 250px); }
        .step-section { margin-bottom: 2rem; padding: 1.5rem; background: var(--zh-gray-light); border-radius: var(--border-radius); border: 2px solid transparent; transition: all 0.3s ease; }
        .step-section.active { border-color: var(--zh-blue); background: var(--zh-white); box-shadow: 0 0 0 3px rgba(15,5,160,0.1); }
        .step-section.completed { opacity: 0.8; background: var(--zh-blue-lighter); }
        .step-header { display: flex; align-items: center; margin-bottom: 1rem; }
        .step-number { background: var(--zh-blue); color: var(--zh-white); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 1rem; }
        .step-title { font-size: 1.1rem; font-weight: 600; color: var(--zh-blue); }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--zh-gray-dark); }
        select, textarea, input { width: 100%; padding: 0.75rem; border: 2px solid var(--zh-gray); border-radius: var(--border-radius); font-size: 1rem; transition: border-color 0.3s ease; background: var(--zh-white); }
        select:focus, textarea:focus, input:focus { outline: none; border-color: var(--zh-blue); box-shadow: 0 0 0 3px rgba(15,5,160,0.1); }
        textarea { min-height: 120px; resize: vertical; font-family: inherit; }
        .button-group { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
        button, .back-button { padding: 0.75rem 1.5rem; border-radius: var(--border-radius); border: none; font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary, .back-button { background: var(--zh-blue); color: var(--zh-white); text-decoration: none; }
        .btn-primary:hover:not(:disabled), .back-button:hover { background: var(--zh-blue-light); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(15,5,160,0.3); }
        .btn-secondary { background: var(--zh-gray); color: #333; }
        .btn-secondary:hover:not(:disabled) { background: #D0D0D0; }
        .btn-success { background: var(--zh-success); color: var(--zh-white); }
        .btn-danger { background: var(--zh-danger); color: var(--zh-white); }
        .preview-column { flex: 1; background: var(--zh-white); border-radius: var(--border-radius); box-shadow: var(--shadow); display: flex; flex-direction: column; max-height: calc(100vh - 250px); }
        .preview-header { padding: 1.5rem; border-bottom: 2px solid var(--zh-gray-light); background: var(--zh-gray-light); }
        .preview-content { flex: 1; padding: 1.5rem; overflow-y: auto; }
        .preview-content h3 { color: var(--zh-blue); margin: 1.5rem 0 0.75rem; font-size: 1.3rem; border-bottom: 2px solid var(--zh-blue-lighter); padding-bottom: 0.5rem; }
        .preview-content h4 { color: var(--zh-blue); margin: 1.5rem 0 0.75rem; font-size: 1.1rem; }
        .preview-content ul, .preview-content ol { margin-left: 1.5rem; line-height: 1.8; }
        .preview-content .meta-info { background: var(--zh-gray-light); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem; }
        .preview-content .meta-info p { margin: 0.25rem 0; }
        .preview-footer { padding: 1rem 1.5rem; border-top: 2px solid var(--zh-gray-light); background: var(--zh-gray-light); }
        .bewertung-row { display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; }
        .bewertung-row input, .bewertung-row select { padding: 0.5rem; }
        .total-row { font-weight: bold; margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--zh-blue); }
        .help-info { background: var(--zh-blue-lighter); border-left: 4px solid var(--zh-blue); padding: 0.75rem; margin: 0.5rem 0; border-radius: var(--border-radius); font-size: 0.9rem; color: var(--zh-gray-dark); }
        .info-badge { display: inline-block; background: var(--zh-blue); color: var(--zh-white); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; margin-left: 0.5rem; }
        .competence-category { margin: 1rem 0; padding: 0.5rem; background: var(--zh-gray-light); border-radius: var(--border-radius); }
        .competence-category h5 { margin: 0 0 0.5rem 0; color: var(--zh-blue); font-size: 0.95rem; }
        .checkbox-container { max-height: 200px; overflow-y: auto; border: 2px solid var(--zh-gray); border-radius: var(--border-radius); padding: 0.75rem; background: var(--zh-white); }
        .checkbox-item { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.35rem 0; }
        .checkbox-item input[type="checkbox"] { width: auto; margin-top: 0.2rem; }
        .checkbox-item label { margin-bottom: 0; font-weight: normal; color: #333; line-height: 1.4; }
        #circularity-assessment { margin-top: 2.5rem; padding: 1.5rem; border: 2px dashed var(--zh-blue-lighter); border-radius: var(--border-radius); }
        #circularity-assessment h4 { margin-top: 0; }
        #circularity-assessment p { font-size: 0.95rem; line-height: 1.6; color: var(--zh-gray-dark); }
        #circularity-assessment h5 { color: var(--zh-blue); font-size: 1rem; margin-top: 1rem; margin-bottom: 0.5rem;}
        #circularity-results div { background: var(--zh-gray-light); padding: 1rem; border-radius: var(--border-radius); min-height: 40px; }
        .back-button-container { padding: 1.5rem 1.5rem 0 1.5rem; background-color: var(--zh-white); max-width: 1600px; margin: 0 auto;}
        .back-button-container.bottom { padding-top: 0; padding-bottom: 1.5rem; }
        @media (max-width: 768px) { .container { flex-direction: column; } .wizard-column, .preview-column { width: 100%; max-height: none; } }
        @media print { .wizard-column, .preview-footer, .header, .progress-container, #circularity-assessment-button, .back-button-container { display: none; } .container { display: block; padding: 0; } .preview-column { box-shadow: none; max-height: none; } }
    </style>
</head>
<body>
    <header class="header">
        <h1>SLP EBA Umsetzungsvarianten-Generator</h1>
        <p>Schullehrplan Allgemeinbildung • Kanton Zürich • 2-jährige Grundbildung EBA</p>
    </header>
    <div class="back-button-container">
        <a href="umsetzungsbeispiele.html" class="back-button">← Zurück zu den Umsetzungsbeispielen</a>
    </div>
    <div class="progress-container">
        <div class="progress-text"><span id="progressText">Bitte wählen Sie zuerst ein Lehrjahr</span></div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    </div>
    <div class="container">
        <div class="wizard-column">
            <div class="step-section" data-step="1">
                <div class="step-header"><div class="step-number">1</div><h3 class="step-title">Lehrjahr auswählen</h3></div>
                <div class="button-group">
                    <button id="year1Btn" class="btn-secondary" onclick="selectYear(1)">1. Lehrjahr (Themen 1-4)</button>
                    <button id="year2Btn" class="btn-secondary" onclick="selectYear(2)">2. Lehrjahr (Themen 5-8)</button>
                </div>
            </div>
            <div class="step-section" data-step="2">
                <div class="step-header"><div class="step-number">2</div><h3 class="step-title">Thema auswählen</h3></div>
                <select id="thema" disabled onchange="autoProgressStep(2)"><option value="">-- Bitte zuerst Lehrjahr wählen --</option></select>
            </div>
            <div class="step-section" data-step="3">
                <div class="step-header"><div class="step-number">3</div><h3 class="step-title">Individueller Lebensbezug</h3></div>
                <select id="lebensbezug" disabled onchange="autoProgressStep(3)"><option value="">-- Bitte zuerst Thema wählen --</option></select>
            </div>
            <div class="step-section" data-step="4">
                <div class="step-header"><div class="step-number">4</div><h3 class="step-title">Lerninhalt</h3></div>
                <select id="lerninhalt" disabled onchange="autoProgressStep(4)"><option value="">-- Bitte zuerst Lebensbezug wählen --</option></select>
            </div>
            <div class="step-section" data-step="5">
                <div class="step-header"><div class="step-number">5</div><h3 class="step-title">Kompetenzen auswählen</h3></div>
                <div class="competence-category">
                    <h5>Schlüsselkompetenzen <span class="info-badge">Mind. 1</span></h5>
                    <div id="schluesselkompetenzen-container" class="checkbox-container"><small>-- Werden nach Lerninhalt geladen --</small></div>
                </div>
                <div class="competence-category">
                    <h5>Sprachmodi <span class="info-badge">Mind. 1</span></h5>
                    <div id="sprachmodi-container" class="checkbox-container"><small>-- Werden nach Lerninhalt geladen --</small></div>
                </div>
                <div class="competence-category">
                    <h5>Handlungsfelder der gesellschaftlichen Aspekte <span class="info-badge">Mind. 1</span></h5>
                    <div id="gesellschaftliche-container" class="checkbox-container"><small>-- Werden nach Lerninhalt geladen --</small></div>
                </div>
                <div class="competence-category">
                    <h5>Digitale Kompetenzen <span class="info-badge">Mind. 1</span></h5>
                    <div id="digitale-container" class="checkbox-container"><small>-- Werden nach Lerninhalt geladen --</small></div>
                </div>
                <div class="button-group">
                    <button class="btn-success" onclick="confirmCompetencies()">✓ Übernehmen & Weiter</button>
                </div>
            </div>
            <div class="step-section" data-step="6">
                <div class="step-header"><div class="step-number">6</div><h3 class="step-title">Herausforderung</h3></div>
                <textarea id="herausforderung" disabled placeholder="Die Herausforderung beschreibt die konkrete Problemstellung..."></textarea>
                <div class="button-group">
                    <button class="btn-primary" onclick="generateWithAI(6)" disabled>🤖 KI-Generierung</button>
                    <button class="btn-secondary" onclick="enableManualEdit(6)" disabled>✏️ Selbst schreiben</button>
                    <button class="btn-danger" onclick="resetField(6)" disabled>🔄 Zurücksetzen</button>
                    <button class="btn-success" onclick="confirmStep(6)" disabled>✓ Übernehmen</button>
                </div>
            </div>
            <div class="step-section" data-step="7">
                <div class="step-header"><div class="step-number">7</div><h3 class="step-title">Produkt</h3></div>
                <textarea id="produkt" disabled placeholder="Das Produkt ist das konkrete Ergebnis der Lernaufgabe..."></textarea>
                <div class="button-group">
                    <button class="btn-primary" onclick="generateWithAI(7)" disabled>🤖 KI-Generierung</button>
                    <button class="btn-secondary" onclick="enableManualEdit(7)" disabled>✏️ Selbst schreiben</button>
                    <button class="btn-danger" onclick="resetField(7)" disabled>🔄 Zurücksetzen</button>
                    <button class="btn-success" onclick="confirmStep(7)" disabled>✓ Übernehmen</button>
                </div>
            </div>
            <div class="step-section" data-step="8">
                <div class="step-header"><div class="step-number">8</div><h3 class="step-title">Eingesetzte Sprachmodi & Scaffolds</h3></div>
                <textarea id="scaffolds" disabled placeholder="Beschreiben Sie die Scaffolds für jeden gewählten Sprachmodus..."></textarea>
                <div class="button-group">
                    <button class="btn-primary" onclick="generateWithAI(8)" disabled>🤖 KI-Generierung</button>
                    <button class="btn-secondary" onclick="enableManualEdit(8)" disabled>✏️ Selbst schreiben</button>
                    <button class="btn-danger" onclick="resetField(8)" disabled>🔄 Zurücksetzen</button>
                    <button class="btn-success" onclick="confirmStep(8)" disabled>✓ Übernehmen</button>
                </div>
            </div>
            <div class="step-section" data-step="9">
                <div class="step-header"><div class="step-number">9</div><h3 class="step-title">Bewertungspositionen</h3></div>
                <div id="bewertungContainer">
                    <div class="bewertung-row">
                        <strong>Kriterium</strong><strong>Kompetenz</strong><strong>Punkte</strong><strong>Bereich</strong><strong>Aktion</strong>
                    </div>
                </div>
                <button class="btn-secondary" onclick="addBewertungRow()">+ Kriterium hinzufügen</button>
                <div class="total-row">Total: <span id="totalPoints">0</span> / 100 Punkte</div>
                <div class="help-info">Die Bewertung soll sich auf Sprache & Kommunikation sowie Gesellschaft beziehen (je ca. 50%).</div>
                <div class="button-group">
                    <button class="btn-primary" onclick="generateWithAI(9)" disabled>🤖 KI-Generierung</button>
                    <button class="btn-danger" onclick="resetBewertung()" disabled>🔄 Zurücksetzen</button>
                    <button class="btn-success" onclick="confirmStep(9)" disabled>✓ Übernehmen</button>
                </div>
            </div>
        </div>
        <div class="preview-column">
            <div class="preview-header"><h2>Vorschau der Umsetzungsvariante</h2></div>
            <div class="preview-content" id="previewContent">
                <p style="color: #999; text-align: center; margin-top: 2rem;">Bitte füllen Sie die Schritte aus, um eine Vorschau zu sehen.</p>
            </div>
            <div class="preview-footer">
                <div class="button-group">
                    <button class="btn-primary" onclick="printPreview()">🖨️ Drucken</button>
                    <button class="btn-secondary" onclick="copyToClipboard()">📋 Kopieren</button>
                    <button class="btn-secondary" onclick="exportAsJSON()">💾 Export JSON</button>
                </div>
            </div>
        </div>
    </div>
    <div class="back-button-container bottom">
        <a href="umsetzungsbeispiele.html" class="back-button">← Zurück zu den Umsetzungsbeispielen</a>
    </div>

    <script>
        const CLOUDFLARE_WORKER_URL = "https://abu-aufgaben-api.cglaus.workers.dev";
        const TOTAL_STEPS = 9;
        let SLP_DATA = {};
        let SCHLUESSELKOMPETENZEN = {};
        let SPRACHMODI = {};
        let GESELLSCHAFTLICHE = {};
        const appState = {
            lehrjahr: null,
            currentStep: 1,
            completedSteps: [],
            data: { thema: '', lebensbezug: '', lerninhalt: '', schluesselkompetenzen: [], sprachmodi: [], gesellschaftliche: [], digitale: [], herausforderung: '', produkt: '', scaffolds: '', bewertung: [] }
        };

        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            document.getElementById('progressText').textContent = 'Lade Grundlagendaten...';
            try {
                const [slp1_text, slp2_text] = await Promise.all([
                    fetch('./SLPEBALJ1.txt').then(res => res.text()),
                    fetch('./SLPEBALJ2.txt').then(res => res.text())
                ]);
                SLP_DATA = parseSlpToStructuredData(slp1_text, slp2_text);
                document.getElementById('progressText').textContent = 'Bitte wählen Sie zuerst ein Lehrjahr';
                addBewertungRow();
                updateStepVisuals();
            } catch (error) {
                console.error("Fehler beim Laden der Grundlagendaten:", error);
                document.getElementById('progressText').textContent = 'Fehler: Grundlagendaten konnten nicht geladen werden.';
            }
        }

        function parseSlpToStructuredData(slp1_text, slp2_text) {
            SCHLUESSELKOMPETENZEN = {"3.2.1":"Zwischen relevanten und irrelevanten Quellen und Inhalten unterscheiden", "3..2":"Sich selbst Ziele setzen, die Zielsetzung überprüfen und sich adaptiv verhalten", "3.2.3":"Antizipative, unternehmerische und innovative Wege der Problemlösung", "3.2.4":"In unterschiedlichen Teams zielgerichtet und effizient arbeiten", "3.2.5":"Die eigenen Werthaltungen und Überzeugungen erkennen und reflektieren", "3.2.6":"Ihre eigenen Standpunkte begründen und andere davon überzeugen", "3.2.7":"Unterschiedliche Standpunkte nachvollziehen und Verständnis fördern", "3.2.8":"Ihre Lebensphasen planen und mit Unwägbarkeiten umgehen", "3.2.9":"Vernetzt und systemisch denken, um nachhaltig zu handeln", "3.2.10":"Sich in einem sich ständig verändernden Umfeld zurechtfinden", "3.2.11":"Mit Mehrdeutigkeiten umgehen", "3.2.12":"An gesellschaftlichen Prozessen partizipieren und Handlungsspielräume nutzen"};
            SPRACHMODI = {"4.2.1.1":"Rezeption mündlich", "4.2.1.2":"Rezeption audiovisuell", "4.2.1.3":"Rezeption schriftlich und bildlich", "4.2.2.1":"Produktion mündlich", "4.2.2.2":"Produktion schriftlich und bildlich", "4.2.2.3":"Produktion multimedial", "4.2.3.1":"Interaktion und Kollaboration mündlich", "4.2.3.2":"Interaktion und Kollaboration schriftlich", "4.2.3.3":"Interaktion und Kollaboration digital"};
            GESELLSCHAFTLICHE = {"5.2.1.1":"Ethik - Empathisch handeln und andere Perspektiven übernehmen", "5.2.1.2":"Ethik - Verantwortung für Integrität und Würde übernehmen", "5.2.1.3":"Ethik - Aktiv an moralischen Entscheiden beteiligen", "5.2.2.1":"Identität - Persönlichkeit erkunden und entwickeln", "5.2.2.2":"Identität - Auf Gesundheit achten und Diskriminierung erkennen", "5.2.2.3":"Identität - Identitätsstiftende Räume erkunden", "5.2.2.4":"Identität - Andere kulturelle Realitäten anerkennen", "5.2.3.1":"Kultur - Bewusstsein für gestaltete Welt entwickeln", "5.2.3.2":"Kultur - Mit grundlegenden Lebensthemen auseinandersetzen", "5.2.3.3":"Kultur - Eigene Wahrnehmungen reflektieren", "5.2.3.4":"Kultur - Gestaltungs- und Ausdrucksfähigkeiten erproben", "5.2.4.1":"Ökologie - Eigenes Verhalten unter Nachhaltigkeitsaspekt analysieren", "5.2.4.2":"Ökologie - Lösungsansätze für nachhaltige Ressourcennutzung", "5.2.5.1":"Politik - Politische Fragen analysieren und Manipulation erkennen", "5.2.5.2":"Politik - Eigene politische Meinungen und Werte entwickeln", "5.2.5.3":"Politik - Politische Organisation verstehen und partizipieren", "5.2.6.1":"Recht - Funktionsweise der Institutionen verstehen", "5.2.6.2":"Recht - Juristische Regeln und Werthaltungen verstehen", "5.2.6.3":"Recht - Juristische Informationen in Konflikten interpretieren", "5.2.6.4":"Recht - Juristische Normen zum Interessenschutz nutzen", "5.2.7.1":"Technologie - Einfluss von Technologien analysieren", "5.2.7.2":"Technologie - IKT zweckmässig und verantwortungsbewusst nutzen", "5.2.8.1":"Wirtschaft - Als Konsument mit knappen Ressourcen wählen", "5.2.8.2":"Wirtschaft - Wirtschaftliche Akteure und eigene Lage verstehen", "5.2.8.3":"Wirtschaft - Erwartungen an Unternehmen und Entwicklungen analysieren"};
            return { lehrjahr1: { themen: [ { nummer: 1, titel: "Ins Berufsleben einsteigen", lektionen: 22, leitidee: "Ich finde meinen Platz in der Berufswelt...", lebensbezuege: [ { titel: "Ich finde mich im Betrieb und in der Berufsfachschule zurecht", lerninhalte: [ { titel: "Ich orientiere mich in der Arbeits- und Ausbildungswelt", sprachmodi: ["4.2.1.1", "4.2.1.2", "4.2.1.3", "4.2.2.2", "4.2.3.1", "4.2.3.3"], schluesselkompetenzen: ["3.2.2", "3.2.8", "3.2.10"], gesellschaftliche: ["5.2.6.3", "5.2.6.4", "5.2.2.3"], digitale: ["Einrichten von ICT-Tools", "Suchfunktion nutzen (Ctrl+F)", "Vorlesen lassen im Browser", "Screenshots erstellen", "KI-Suche nutzen"] }, { titel: "Ich kenne Lernstrategien und arbeite ressourcenschonend", sprachmodi: ["4.2.1.3", "4.2.1.2", "4.2.2.2"], schluesselkompetenzen: ["3.2.2", "3.2.8", "3.2.10"], gesellschaftliche: ["5.2.2.3"], digitale: ["Digitale Anleitungen nutzen", "Webseitenstruktur verstehen", "Bookmarks setzen"] } ] }, { titel: "Ich kommuniziere auf konstruktive Art und Weise", lerninhalte: [ { titel: "Ich kann mich verständlich und respektvoll ausdrücken", sprachmodi: ["4.2.2.1", "4.2.2.2", "4.2.3.1", "4.2.3.3"], schluesselkompetenzen: ["3.2.6", "3.2.7", "3.2.3"], gesellschaftliche: ["5.2.1.1", "5.2.2.3"], digitale: ["KI-Chat für Dialoge nutzen", "Officeprogramme anwenden"] }, { titel: "Ich kann Konflikte erkennen und adäquat reagieren", sprachmodi: ["4.2.1.2", "4.2.1.3", "4.2.2.2", "4.2.3.1", "4.2.3.3"], schluesselkompetenzen: ["3.2.6", "3.2.7", "3.2.3"], gesellschaftliche: ["5.2.1.1", "5.2.2.2", "5.2.2.3"], digitale: ["Recherchetool nutzen", "Audiodatei abspielen", "Suchfunktion nutzen"] } ] } ] }, { nummer: 2, titel: "Bewusst konsumieren und handeln", lektionen: 22, leitidee: "Ich verstehe, wie mein Konsumverhalten zusammenhängt...", lebensbezuege: [ { titel: "Ich gehe verantwortungsbewusst mit meinem Geld um", lerninhalte: [ { titel: "Ich kann ein Budget erstellen und Risiken identifizieren", sprachmodi: ["4.2.1.1", "4.2.1.2", "4.2.1.3", "4.2.2.2", "4.2.3.1"], schluesselkompetenzen: ["3.2.2", "3.2.6"], gesellschaftliche: ["5.2.7.2", "5.2.8.1"], digitale: ["Digitale Budgethilfen finden", "Excel-Tabellen bedienen", "Gestaltungselemente in Word"] }, { titel: "Ich kann Strategien für nachhaltigen Konsum umsetzen", sprachmodi: ["4.2.1.2", "4.2.1.3", "4.2.2.3"], schluesselkompetenzen: ["3.2.1", "3.2.6", "3.2.9", "3.2.3"], gesellschaftliche: ["5.2.4.1", "5.2.4.2", "5.2.8.1"], digitale: ["Umfragetool nutzen", "Umfrage-Fragen mit KI entwickeln", "Untertitel einblenden", "Videogeschwindigkeit anpassen"] } ] }, { titel: "Ich konsumiere bewusst und verstehe wirtschaftliche Zusammenhänge", lerninhalte: [ { titel: "Ich kann Produktionsprozesse beschreiben", sprachmodi: ["4.2.1.1", "4.2.1.3", "4.2.2.2"], schluesselkompetenzen: ["3.2.1", "3.2.10"], gesellschaftliche: ["5.2.7.2", "5.2.8.2"], digitale: ["Mediale Erfassung mit Ton/Bild", "Verlaufsdiagramme erstellen", "Infografiken gestalten"] }, { titel: "Ich kann Phänomene des Massenkonsums erklären", sprachmodi: ["4.2.1.2", "4.2.1.3", "4.2.2.2", "4.2.2.3"], schluesselkompetenzen: ["3.2.3", "3.2.9", "3.2.12"], gesellschaftliche: ["5.2.8.3", "5.2.7.1"], digitale: ["Algorithmen für Werbung identifizieren", "Influencer als Werbeträger erkennen", "Schutzmassnahmen gegen Werbung"] } ] } ] }, { nummer: 3, titel: "Risiko und Sicherheit", lektionen: 22, leitidee: "Sicherheit beginnt mit dem Erkennen von Risiken...", lebensbezuege: [ { titel: "Ich kann Risiken einschätzen und mich absichern", lerninhalte: [ { titel: "Ich erkenne Risiken privat und am Arbeitsplatz", sprachmodi: ["4.2.1.1", "4.2.1.3", "4.2.1.2", "4.2.2.1", "4.2.2.2"], schluesselkompetenzen: ["3.2.1", "3.2.2", "3.2.8", "3.2.9"], gesellschaftliche: ["5.2.2.2", "5.2.8.2"], digitale: ["Digitale Präsentationsformen nutzen", "Digitale Inhalte erstellen", "KI-Funktionen für Überarbeitungen"] }, { titel: "Ich kann beschreiben, wie ich mich absichern kann", sprachmodi: ["4.2.2.2", "4.2.2.3", "4.2.2.1", "4.2.3.1", "4.2.3.3"], schluesselkompetenzen: ["3.2.1", "3.2.2", "3.2.8", "3.2.9"], gesellschaftliche: ["5.2.6.3", "5.2.8.2", "5.2.7.2"], digitale: ["Medienkanal bedienen", "Mediale Inhalte bearbeiten", "Digitale Tools für Informationen", "KI für Bearbeitung nutzen"] } ] }, { titel: "Ich kann reflektieren, wie ich gesund leben kann", lerninhalte: [ { titel: "Ich erkenne gesellschaftliche Normen und deren Einfluss", sprachmodi: ["4.2.1.3", "4.2.3.1", "4.2.3.3", "4.2.2.3"], schluesselkompetenzen: ["3.2.5", "3.2.6", "3.2.7", "3.2.12"], gesellschaftliche: ["5.2.2.2", "5.2.3.2", "5.2.7.2"], digitale: ["Bildbearbeitungsprogramm bedienen", "Social-Media-Algorithmus beeinflussen", "Transkriptions-Tool anwenden"] }, { titel: "Ich kann Möglichkeiten für gesunden Lebensstil protokollieren", sprachmodi: ["4.2.1.1", "4.2.2.2", "4.2.3.1", "4.2.2.3"], schluesselkompetenzen: ["3.2.1", "3.2.7"], gesellschaftliche: ["5.2.2.2", "5.2.8.3"], digitale: ["Selbstbeobachtung-Tools einstellen"] } ] } ] }, { nummer: 4, titel: "Medien und digitale Welt", lektionen: 22, leitidee: "Medien und digitale Technologien prägen meinen Alltag...", lebensbezuege: [ { titel: "Ich nutze KI und digitale Werkzeuge gezielt", lerninhalte: [ { titel: "Ich kann digitale Werkzeuge zuordnen und nutzen", sprachmodi: ["4.2.2.1", "4.2.2.2", "4.2.2.3", "4.2.3.3"], schluesselkompetenzen: ["3.2.3", "3.2.10", "3.2.9", "3.2.6"], gesellschaftliche: ["5.2.7.1", "5.2.8.2"], digitale: ["Tabellarische Darstellung erstellen", "Präsentationsmedium gestalten", "Ausgewählte Tool-Funktionen anwenden"] }, { titel: "Ich kann KI verstehen und mit Prompts arbeiten", sprachmodi: ["4.2.3.3"], schluesselkompetenzen: ["3.2.3", "3.2.10", "3.2.9", "3.2.6"], gesellschaftliche: ["5.2.7.1", "5.2.3.4", "5.2.6.3"], digitale: ["Dateien auf KI hochladen", "Filterfunktionen bedienen", "Datenschutz-Einstellungen vornehmen"] } ] }, { titel: "Ich recherchiere gezielt und kommuniziere selbstbestimmt", lerninhalte: [ { titel: "Ich stärke meine Medienkompetenz für Suche und Analyse", sprachmodi: ["4.2.1.3", "4.2.3.1", "4.2.3.3"], schluesselkompetenzen: ["3.2.1", "3.2.10", "3.2.11", "3.2.12"], gesellschaftliche: ["5.2.7.2", "5.2.7.1"], digitale: ["Durchsuchen und Filtern von Daten", "Medienarchive nutzen (swissdox, SRF)", "Auswertung digitaler Inhalte"] }, { titel: "Ich nutze Social Media selbstbestimmt und respektvoll", sprachmodi: ["4.2.2.2", "4.2.3.1", "4.2.3.3"], schluesselkompetenzen: ["3.2.1", "3.2.10", "3.2.11", "3.2.12"], gesellschaftliche: ["5.2.7.2", "5.2.1.1", "5.2.3.4", "5.2.6.3"], digitale: ["Inhalte teilen und löschen", "Datenschutz-Einstellungen", "Digitale Identitäten verwalten", "Schutz des eigenen Rufs"] } ] } ] } ] }, lehrjahr2: { themen: [ { nummer: 5, titel: "Meinung bilden, akzeptieren und mitgestalten", lektionen: 22, leitidee: "Ich lebe in einer Welt voller Informationen...", lebensbezuege: [ { titel: "Ich bilde mir eine Meinung und rege andere zum Nachdenken an", lerninhalte: [ { titel: "Ich kann Beiträge verstehen und Manipulation erkennen", sprachmodi: ["4.2.1.1", "4.2.1.2", "4.2.2.1", "4.2.2.2", "4.2.2.3"], schluesselkompetenzen: ["3.2.1", "3.2.11"], gesellschaftliche: ["5.2.7.2", "5.2.5.1"], digitale: ["Quellenüberprüfte Medienarchive nutzen", "Kriterien für Fake News aufzählen"] }, { titel: "Ich kann Standpunkte entwickeln und vertreten", sprachmodi: ["4.2.1.1", "4.2.1.2", "4.2.2.1", "4.2.2.2", "4.2.3.1"], schluesselkompetenzen: ["3.2.5", "3.2.6", "3.2.7", "3.2.12", "3.2.9"], gesellschaftliche: ["5.2.1.3", "5.2.5.1"], digitale: ["Gestaltung digitaler Beiträge", "Mit KI Argumentationsstrukturen üben"] }, { titel: "Ich kann ein mediengestütztes Produkt gestalten", sprachmodi: ["4.2.2.3", "4.2.3.3"], schluesselkompetenzen: ["3.2.1", "3.2.11"], gesellschaftliche: ["5.2.7.2", "5.2.3.4"], digitale: ["Stichwortsuche in Rechercheprogrammen", "Zugriff auf Meinungsbildungsplattformen", "KI-Assistenz für Medienprodukte"] } ] }, { titel: "Ich kenne meine politischen Rechte", lerninhalte: [ { titel: "Ich kann politische Systeme erklären", sprachmodi: ["4.2.1.1", "4.2.1.2", "4.2.1.3", "4.2.2.3", "4.2.3.1", "4.2.3.3"], schluesselkompetenzen: ["3.2.11", "3.2.12"], gesellschaftliche: ["5.2.5.3", "5.2.6.1"], digitale: ["Medienarchive zu politischen Beteiligungsmöglichkeiten", "Such- und Filterstrategien einsetzen"] }, { titel: "Ich kann meine Meinung zu politischen Fragen darlegen", sprachmodi: ["4.2.1.2", "4.2.3.1", "4.2.3.2", "4.2.3.3"], schluesselkompetenzen: ["3.2.5", "3.2.6", "3.2.7"], gesellschaftliche: ["5.2.2.3", "5.2.5.2"], digitale: ["Tools zur Meinungsbildung nutzen", "Digitale Diskussionsforen nutzen", "Sichtbarkeitseinstellungen von Kommentaren"] }, { titel: "Ich kann einen Beitrag zur politischen Teilhabe gestalten", sprachmodi: ["4.2.2.3", "4.2.3.3"], schluesselkompetenzen: ["3.2.4", "3.2.6"], gesellschaftliche: ["5.2.3.1", "5.2.7.2", "5.2.4.2"], digitale: ["Konzeption digitaler Beiträge", "Video- und Bildgeneratoren einsetzen"] } ] } ] }, { nummer: 6, titel: "Verträge verstehen – fair handeln", lektionen: 22, leitidee: "Ich bewege mich in einem Alltag mit Regeln und Verträgen...", lebensbezuege: [ { titel: "Ich erkenne rechtliche Fragen und kläre meine Rechte", lerninhalte: [ { titel: "Ich kann Alltagsverträge verstehen", sprachmodi: ["4.2.1.3", "4.2.1.2", "4.2.2.2", "4.2.3.3"], schluesselkompetenzen: ["3.2.1", "3.2.6", "3.2.12"], gesellschaftliche: ["5.2.6.2", "5.2.8.2"], digitale: ["Digitale Recherche auf Konsumentenplattformen", "Digitale Tools zur Textanalyse", "Beratungstipps in Medienarchiven"] }, { titel: "Ich erkenne, wann rechtliche Abklärung notwendig ist", sprachmodi: ["4.2.2.2", "4.2.3.1", "4.2.3.2", "4.2.3.3"], schluesselkompetenzen: ["3.2.1", "3.2.6", "3.2.12"], gesellschaftliche: ["5.2.1.2", "5.2.6.3", "5.2.2.3"], digitale: ["Auf AGB/rechtliche Bestimmungen zugreifen", "Kontaktaufnahme digital strukturieren", "Kontaktadressen identifizieren"] } ] }, { titel: "Ich lerne, wie ich fair handeln kann", lerninhalte: [ { titel: "Ich kann ethische von rechtlichen Bestimmungen unterscheiden", sprachmodi: ["4.2.3.2", "4.2.3.3", "4.2.2.1", "4.2.2.2"], schluesselkompetenzen: ["3.2.2", "3.2.4", "3.2.5", "3.2.9", "3.2.10"], gesellschaftliche: ["5.2.1.2", "5.2.6.2"], digitale: ["Medienarchive nutzen"] }, { titel: "Ich kann Verhaltensweisen für Konfliktlösungen beschreiben", sprachmodi: ["4.2.2.2", "4.2.3.1", "4.2.3.2"], schluesselkompetenzen: ["3.2.2", "3.2.4", "3.2.5", "3.2.9", "3.2.10"], gesellschaftliche: ["5.2.1.1", "5.2.1.3"], digitale: ["Datenschutzvorgaben beachten"] } ] } ] }, { nummer: 7, titel: "Arbeit und Steuerpflicht", lektionen: 22, leitidee: "Ich gestalte meinen Weg – beruflich und finanziell...", lebensbezuege: [ { titel: "Ich finde heraus, wohin ich beruflich will", lerninhalte: [ { titel: "Ich setze mich mit meinen Fähigkeiten auseinander", sprachmodi: ["4.2.2.2", "4.2.2.3", "4.2.3.1"], schluesselkompetenzen: ["3.2.5", "3.2.8"], gesellschaftliche: ["5.2.2.1", "5.2.2.3", "5.2.8.3", "5.2.7.1"], digitale: ["Simulation von Bewerbungsgesprächen", "Erstellung eines Bewerbungsvideos", "Präsentation der Stärken", "Digitales Porträt erstellen"] }, { titel: "Ich plane meine Laufbahn und bewerbe mich gezielt", sprachmodi: ["4.2.1.3", "4.2.2.2", "4.2.3.2", "4.2.3.3"], schluesselkompetenzen: ["3.2.2", "3.2.4", "3.2.5", "3.2.6", "3.2.8", "3.2.10"], gesellschaftliche: ["5.2.8.2", "5.2.8.3", "5.2.6.3"], digitale: ["Stellenangebote auf Plattformen recherchieren", "KI-Tools für Stellenanalyse", "Digitale Textassistenz", "Korrektur- und Stilprüfprogramme", "Online-Formulare nutzen", "Digitale Simulationstools", "Bewerbungsvideos produzieren", "Datenschutz bei Online-Bewerbungen"] } ] }, { titel: "Ich kann meine Pflichten gegenüber Staat benennen", lerninhalte: [ { titel: "Ich erstelle eine Übersicht meiner Aufgaben", sprachmodi: ["4.2.1.2", "4.2.3.1", "4.2.2.2"], schluesselkompetenzen: ["3.2.10", "3.2.11", "3.2.12"], gesellschaftliche: ["5.2.5.3", "5.2.8.2", "5.2.6.1"], digitale: ["Lohn- und Steuerrechner nutzen", "Digitale Lohnabrechnungen analysieren", "Visualisierung von Abzügen"] }, { titel: "Ich stelle Unterlagen zusammen und reiche sie ein", sprachmodi: ["4.2.1.3", "4.2.2.2", "4.2.3.2"], schluesselkompetenzen: ["3.2.1", "3.2.2", "3.2.11"], gesellschaftliche: ["5.2.6.4", "5.2.8.2"], digitale: ["Online-Formulare nutzen", "Uploads und Scans von Belegen", "Menuleiste einer Internetseite bedienen"] } ] } ] }, { nummer: 8, titel: "Kunst und Kultur", lektionen: 22, leitidee: "Ich gestalte Kultur mit – und mache Themen sichtbar...", lebensbezuege: [ { titel: "Ich erlebe, wie Kultur Zugehörigkeit schafft", lerninhalte: [ { titel: "Ich kann kulturelle Ausdrucksformen beschreiben", sprachmodi: ["4.2.1.1", "4.2.2.1", "4.2.2.3", "4.2.3.1", "4.2.3.3"], schluesselkompetenzen: ["3.2.5", "3.2.10", "3.2.11"], gesellschaftliche: ["5.2.3.3", "5.2.2.4"], digitale: ["Medienarchive mit Filter nutzen", "KI-Quellensuche für kulturelle Beispiele", "Gespräche mit Audioaufnahmen speichern", "KI-Assistenz für Zusammenhänge"] }, { titel: "Ich kann kulturelle Phänomene reflektieren", sprachmodi: ["4.2.1.2", "4.2.1.3", "4.2.2.2"], schluesselkompetenzen: ["3.2.7", "3.2.12"], gesellschaftliche: ["5.2.1.1", "5.2.5.2", "5.2.2.1"], digitale: ["Medienarchive gezielt nutzen", "KI-Assistenz für Zusammenhänge"] } ] }, { titel: "Ich finde kreative Wege für gesellschaftliche Themen", lerninhalte: [ { titel: "Ich kann kreative Ausdrucksformen nutzen", sprachmodi: ["4.2.2.2", "4.2.2.3", "4.2.3.1", "4.2.3.3"], schluesselkompetenzen: ["3.2.2", "3.2.3", "3.2.4"], gesellschaftliche: ["5.2.3.4", "5.2.4.2", "5.2.2.1"], digitale: ["Tools für Audio/Bild/Video", "Memes und Kurzfilme gestalten", "Urheberrecht beachten", "KI-Assistenten nutzen"] }, { titel: "Ich lerne, respektvoll über Kunst zu sprechen", sprachmodi: ["4.2.1.1", "4.2.2.1", "4.2.2.2", "4.2.3.1"], schluesselkompetenzen: ["3.2.4", "3.2.5", "3.2.7", "3.2.11"], gesellschaftliche: ["5.2.5.2", "5.2.2.1", "5.2.3.2", "5.2.2.4"], digitale: ["Digitale Plattformen für Kunstdiskussion", "KI für Argumentationshilfen", "KI als Kunstwerkgenerator", "Videokonferenz als Austauschort"] } ] } ] } ] } };
        }

        async function generateWithAI(uiStep) {
            const button = event.target;
            button.disabled = true;
            button.innerHTML = 'KI arbeitet...';
            const apiStep = uiStep > 5 ? uiStep - 1 : uiStep;
            
            const getSelectedText = (selectId) => {
                const select = document.getElementById(selectId);
                return select.selectedIndex > 0 ? select.options[select.selectedIndex].text : '';
            };
            const getKompetenzTexte = (ids, sourceMap) => {
                return ids.filter(id => id).map(id => `${id} - ${sourceMap[id]}`).join('\n');
            };

            const context = {
                stepToGenerate: apiStep,
                lehrjahr: appState.lehrjahr,
                thema: { text: getSelectedText('thema') },
                lebensbezug: { text: getSelectedText('lebensbezug') },
                lerninhalt: { text: getSelectedText('lerninhalt') },
                schluesselkompetenzen: getKompetenzTexte(appState.data.schluesselkompetenzen, SCHLUESSELKOMPETENZEN),
                sprachmodi: getKompetenzTexte(appState.data.sprachmodi, SPRACHMODI),
            };

            try {
                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(context)
                });
                
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.generatedText || `Worker-Fehler: ${response.status}`);
                }

                if (uiStep === 9) {
                    if (result.bewertung) {
                        populateBewertung(result.bewertung);
                    } else {
                        alert("Die KI konnte keine gültigen Bewertungskriterien im JSON-Format erstellen. Bitte versuchen Sie es erneut oder fügen Sie die Kriterien manuell hinzu.\n\nAntwort der KI:\n" + (result.generatedText || "Keine Textantwort erhalten."));
                    }
                } else if (result.generatedText) {
                    const fieldMap = { 6: 'herausforderung', 7: 'produkt', 8: 'scaffolds' };
                    if (fieldMap[uiStep]) {
                        const field = document.getElementById(fieldMap[uiStep]);
                        field.value = result.generatedText;
                        field.disabled = false;
                    } else {
                        alert(result.generatedText);
                    }
                }
            } catch (error) {
                console.error("Fehler bei der KI-Anfrage:", error);
                alert(`Die KI-Anfrage ist fehlgeschlagen: ${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = '🤖 KI-Generierung';
            }
        }

        function selectYear(year) {
            appState.lehrjahr = year;
            document.getElementById('year1Btn').classList.toggle('btn-primary', year === 1);
            document.getElementById('year1Btn').classList.toggle('btn-secondary', year !== 1);
            document.getElementById('year2Btn').classList.toggle('btn-primary', year === 2);
            document.getElementById('year2Btn').classList.toggle('btn-secondary', year !== 2);
            appState.data = { thema: '', lebensbezug: '', lerninhalt: '', schluesselkompetenzen: [], sprachmodi: [], gesellschaftliche: [], digitale: [], herausforderung: '', produkt: '', scaffolds: '', bewertung: [] };
            appState.completedSteps = [];
            loadThemen();
            document.getElementById('thema').disabled = false;
            markStepCompleted(1);
            updatePreview();
        }

        function loadThemen() {
            const themaSelect = document.getElementById('thema');
            const data = appState.lehrjahr === 1 ? SLP_DATA.lehrjahr1 : SLP_DATA.lehrjahr2;
            themaSelect.innerHTML = '<option value="">-- Bitte wählen --</option>';
            data.themen.forEach(thema => {
                const option = document.createElement('option');
                option.value = thema.nummer;
                option.textContent = `Thema ${thema.nummer}: ${thema.titel}`;
                themaSelect.appendChild(option);
            });
            document.getElementById('lebensbezug').innerHTML = '<option value="">-- Bitte zuerst Thema wählen --</option>';
            document.getElementById('lerninhalt').innerHTML = '<option value="">-- Bitte zuerst Lebensbezug wählen --</option>';
        }

        function autoProgressStep(step) {
            switch(step) {
                case 2:
                    appState.data.thema = document.getElementById('thema').value;
                    if (appState.data.thema) { loadLebensbezuege(); markStepCompleted(2); }
                    break;
                case 3:
                    appState.data.lebensbezug = document.getElementById('lebensbezug').value;
                    if (appState.data.lebensbezug) { loadLerninhalte(); markStepCompleted(3); }
                    break;
                case 4:
                    appState.data.lerninhalt = document.getElementById('lerninhalt').value;
                    if (appState.data.lerninhalt) { loadAllKompetenzen(); markStepCompleted(4); }
                    break;
            }
            updateProgress();
            updatePreview();
        }
        
        function confirmCompetencies() {
            const sk = Array.from(document.querySelectorAll('#schluesselkompetenzen-container input:checked')).map(cb => cb.value);
            const sm = Array.from(document.querySelectorAll('#sprachmodi-container input:checked')).map(cb => cb.value);
            const g = Array.from(document.querySelectorAll('#gesellschaftliche-container input:checked')).map(cb => cb.value);
            const d = Array.from(document.querySelectorAll('#digitale-container input:checked')).map(cb => cb.value);
            
            if (sk.length < 1) {
                alert("Bitte wählen Sie mindestens eine Schlüsselkompetenz aus.");
                return;
            }
            if (sm.length < 1) {
                alert("Bitte wählen Sie mindestens einen Sprachmodus aus.");
                return;
            }
            if (g.length < 1) {
                alert("Bitte wählen Sie mindestens ein Handlungsfeld der gesellschaftlichen Aspekte aus.");
                return;
            }
            if (d.length < 1) {
                alert("Bitte wählen Sie mindestens eine digitale Kompetenz aus.");
                return;
            }

            appState.data.schluesselkompetenzen = sk;
            appState.data.sprachmodi = sm;
            appState.data.gesellschaftliche = g;
            appState.data.digitale = d;
            
            enableStep(6);
            markStepCompleted(5);
            updateProgress();
            updatePreview();
        }

        function markStepCompleted(step) {
            if (!appState.completedSteps.includes(step)) appState.completedSteps.push(step);
            appState.currentStep = step + 1;
            updateStepVisuals();
            updateProgress();
        }

        function loadLebensbezuege() {
            const lebensbezugSelect = document.getElementById('lebensbezug');
            const data = appState.lehrjahr === 1 ? SLP_DATA.lehrjahr1 : SLP_DATA.lehrjahr2;
            const thema = data.themen.find(t => t.nummer == appState.data.thema);
            lebensbezugSelect.innerHTML = '<option value="">-- Bitte wählen --</option>';
            thema.lebensbezuege.forEach((lb, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = lb.titel;
                lebensbezugSelect.appendChild(option);
            });
            lebensbezugSelect.disabled = false;
        }

        function loadLerninhalte() {
            const lerninhaltSelect = document.getElementById('lerninhalt');
            const data = appState.lehrjahr === 1 ? SLP_DATA.lehrjahr1 : SLP_DATA.lehrjahr2;
            const thema = data.themen.find(t => t.nummer == appState.data.thema);
            const lebensbezug = thema.lebensbezuege[appState.data.lebensbezug];
            lerninhaltSelect.innerHTML = '<option value="">-- Bitte wählen --</option>';
            lebensbezug.lerninhalte.forEach((li, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = li.titel;
                lerninhaltSelect.appendChild(option);
            });
            lerninhaltSelect.disabled = false;
        }

        function populateCheckboxContainer(containerId, competenceIds, sourceMap) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (!competenceIds || competenceIds.length === 0) {
                container.innerHTML = '<small>-- Keine Kompetenzen definiert --</small>';
                return;
            }
            competenceIds.forEach(id => {
                const wrapper = document.createElement('div');
                wrapper.className = 'checkbox-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `${containerId}-${id.replace(/\./g, '-')}`;
                checkbox.value = id;
                checkbox.checked = true;
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = sourceMap ? `${id} - ${sourceMap[id]}` : id;
                wrapper.appendChild(checkbox);
                wrapper.appendChild(label);
                container.appendChild(wrapper);
            });
        }

        function loadAllKompetenzen() {
            const data = appState.lehrjahr === 1 ? SLP_DATA.lehrjahr1 : SLP_DATA.lehrjahr2;
            const thema = data.themen.find(t => t.nummer == appState.data.thema);
            const lebensbezug = thema.lebensbezuege[appState.data.lebensbezug];
            const lerninhalt = lebensbezug.lerninhalte[appState.data.lerninhalt];
            populateCheckboxContainer('schluesselkompetenzen-container', lerninhalt.schluesselkompetenzen, SCHLUESSELKOMPETENZEN);
            populateCheckboxContainer('sprachmodi-container', lerninhalt.sprachmodi, SPRACHMODI);
            populateCheckboxContainer('gesellschaftliche-container', lerninhalt.gesellschaftliche, GESELLSCHAFTLICHE);
            populateCheckboxContainer('digitale-container', lerninhalt.digitale, null);
        }

        function enableStep(step) {
            document.querySelectorAll(`[data-step="${step}"] textarea, [data-step="${step}"] button`).forEach(input => {
                input.disabled = false;
            });
        }

        function confirmStep(step) {
            let valid = false;
            switch(step) {
                case 6: const herausforderung = document.getElementById('herausforderung').value.trim(); if (herausforderung) { appState.data.herausforderung = herausforderung; valid = true; } break;
                case 7: const produkt = document.getElementById('produkt').value.trim(); if (produkt) { appState.data.produkt = produkt; valid = true; } break;
                case 8: const scaffolds = document.getElementById('scaffolds').value.trim(); if (scaffolds) { appState.data.scaffolds = scaffolds; valid = true; } break;
                case 9: const total = calculateTotalPoints(); if (total === 100) { appState.data.bewertung = collectBewertungData(); valid = true; } else { alert('Die Bewertung muss genau 100 Punkte ergeben!'); } break;
            }
            if (valid) {
                markStepCompleted(step);
                if (step < TOTAL_STEPS) enableStep(step + 1);
                updatePreview();
            } else if (step < TOTAL_STEPS) {
                alert('Bitte füllen Sie das Feld aus!');
            }
        }

        function updateProgress() {
            const percentage = (appState.completedSteps.length / TOTAL_STEPS) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = appState.lehrjahr ? `${appState.lehrjahr}. Lehrjahr • Schritt ${appState.currentStep} von ${TOTAL_STEPS}` : 'Bitte wählen Sie zuerst ein Lehrjahr';
        }

        function updateStepVisuals() {
            document.querySelectorAll('.step-section').forEach(section => {
                const step = parseInt(section.dataset.step);
                section.classList.remove('active', 'completed');
                if (step === appState.currentStep) section.classList.add('active');
                else if (appState.completedSteps.includes(step)) section.classList.add('completed');
            });
        }

        function updatePreview() {
            const content = document.getElementById('previewContent');
            if (!appState.lehrjahr) { content.innerHTML = '<p style="color: #999; text-align: center; margin-top: 2rem;">Bitte Lehrjahr wählen.</p>'; return; }
            const data = appState.lehrjahr === 1 ? SLP_DATA.lehrjahr1 : SLP_DATA.lehrjahr2;
            const thema = data.themen.find(t => t.nummer == appState.data.thema);
            let html = `<h3>Umsetzungsvariante - ${appState.lehrjahr}. Lehrjahr</h3>`;
            if (thema) {
                html += `<div class="meta-info">`;
                html += `<p><strong>Thema ${thema.nummer}:</strong> ${thema.titel}</p>`;
                if (appState.data.lebensbezug !== '') {
                    const lb = thema.lebensbezuege[appState.data.lebensbezug];
                    html += `<p><strong>Individueller Lebensbezug:</strong> ${lb.titel}</p>`;
                    if (appState.data.lerninhalt !== '') {
                        const li = lb.lerninhalte[appState.data.lerninhalt];
                        html += `<p><strong>Lerninhalt:</strong> ${li.titel}</p>`;
                    }
                }
                html += `</div>`;
            }
            if (appState.data.herausforderung) html += `<h4>Herausforderung</h4><p>${appState.data.herausforderung.replace(/\n/g, '<br>')}</p>`;
            if (appState.data.produkt) html += `<h4>Produkt</h4><p>${appState.data.produkt.replace(/\n/g, '<br>')}</p>`;
            if (appState.data.sprachmodi.length > 0 && appState.data.scaffolds) {
                html += `<h4>Eingesetzte Sprachmodi und mögliche Scaffolds</h4><ul>`;
                appState.data.sprachmodi.forEach(modus => { html += `<li><strong>${modus} - ${SPRACHMODI[modus]}</strong></li>`; });
                html += `</ul><p><strong>Scaffolds:</strong> ${appState.data.scaffolds.replace(/\n/g, '<br>')}</p>`;
            }
            if (appState.data.bewertung.length > 0) {
                html += `<h4>Bewertungspositionen</h4>`;
                const sk_items = appState.data.bewertung.filter(b => b.bereich === 'SK');
                const g_items = appState.data.bewertung.filter(b => b.bereich === 'G');
                if (sk_items.length > 0) {
                    html += `<p><strong>Sprache & Kommunikation</strong></p><ul>`;
                    sk_items.forEach(item => { html += `<li>${item.kriterium} (${item.punkte} Punkte)</li>`; });
                    html += `</ul>`;
                }
                if (g_items.length > 0) {
                    html += `<p><strong>Gesellschaft</strong></p><ul>`;
                    g_items.forEach(item => { html += `<li>${item.kriterium} (${item.punkte} Punkte)</li>`; });
                    html += `</ul>`;
                }
            }
            
            if(appState.completedSteps.includes(7)) { // Show after product is confirmed
                 html += `
                    <div id="circularity-assessment">
                        <h4>Didaktische Zirkularität bewerten</h4>
                        <p>Lassen Sie die KI analysieren, wie sich Ihre Aufgabe in einen grösseren Lernprozess einbettet.</p>
                        <div class="button-group" id="circularity-assessment-button">
                             <button class="btn-primary" onclick="generateCircularityAssessment()">🤖 Vorkenntnisse & nächste Schritte analysieren</button>
                        </div>
                        <div id="circularity-results" style="margin-top: 1rem;">
                            <h5>Benötigte Vorkenntnisse:</h5>
                            <div id="prerequisites-result">...</div>
                            <h5>Mögliche nächste Lernschritte:</h5>
                            <div id="nextsteps-result">...</div>
                        </div>
                    </div>
                `;
            }

            content.innerHTML = html || '<p style="color: #999;">Noch keine Inhalte vorhanden.</p>';
        }
        
        async function generateCircularityAssessment() {
            const button = event.target;
            const prerequisitesDiv = document.getElementById('prerequisites-result');
            const nextstepsDiv = document.getElementById('nextsteps-result');

            button.disabled = true;
            button.innerHTML = 'KI analysiert...';
            prerequisitesDiv.textContent = '...';
            nextstepsDiv.textContent = '...';

            const getSelectedText = (selectId) => {
                const select = document.getElementById(selectId);
                return select.selectedIndex > 0 ? select.options[select.selectedIndex].text : '';
            };
            const getKompetenzTexte = (ids, sourceMap) => {
                return ids.filter(id => id).map(id => `${id} - ${sourceMap[id]}`).join('\n');
            };
            
            const context = {
                stepToGenerate: 'circularity',
                lehrjahr: appState.lehrjahr,
                thema: { text: getSelectedText('thema') },
                lebensbezug: { text: getSelectedText('lebensbezug') },
                lerninhalt: { text: getSelectedText('lerninhalt') },
                schluesselkompetenzen: getKompetenzTexte(appState.data.schluesselkompetenzen, SCHLUESSELKOMPETENZEN),
                sprachmodi: getKompetenzTexte(appState.data.sprachmodi, SPRACHMODI),
                herausforderung: appState.data.herausforderung,
                produkt: appState.data.produkt
            };

            try {
                const response = await fetch(CLOUDFLARE_WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(context)
                });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.generatedText || `Worker-Fehler: ${response.status}`);
                }

                if (result.circularity && result.circularity.prerequisites && result.circularity.nextSteps) {
                    prerequisitesDiv.textContent = result.circularity.prerequisites;
                    nextstepsDiv.textContent = result.circularity.nextSteps;
                } else {
                     throw new Error("Ungültige Antwort von der KI für Zirkularitäts-Analyse erhalten.");
                }

            } catch(error) {
                console.error("Fehler bei Zirkularitäts-Analyse:", error);
                alert(`Die Analyse ist fehlgeschlagen: ${error.message}`);
                prerequisitesDiv.textContent = 'Fehler bei der Analyse.';
                nextstepsDiv.textContent = 'Fehler bei der Analyse.';
            } finally {
                button.disabled = false;
                button.innerHTML = '🤖 Vorkenntnisse & nächste Schritte analysieren';
            }
        }

        function populateBewertung(bewertungArray) {
            resetBewertung();
            bewertungArray.forEach(item => {
                addBewertungRow(item.kriterium, item.punkte, item.bereich);
            });
            updateTotalPoints();
        }
        function addBewertungRow(kriterium = '', punkte = '', bereich = 'SK') {
            const container = document.getElementById('bewertungContainer');
            const rowDiv = document.createElement('div');
            rowDiv.className = 'bewertung-row';
            const kompetenzOptions = appState.data.schluesselkompetenzen.map(k => `<option value="${k}">${k} - ${SCHLUESSELKOMPETENZEN[k]?.substring(0,30)}...</option>`).join('');
            rowDiv.innerHTML = `<input type="text" placeholder="Bewertungskriterium" value="${kriterium}"><select><option value="">-- Kompetenz --</option>${kompetenzOptions}</select><input type="number" min="0" max="100" placeholder="Punkte" value="${punkte}" oninput="updateTotalPoints()"><select><option value="SK" ${bereich === 'SK' ? 'selected' : ''}>Sprache & Kommunikation</option><option value="G" ${bereich === 'G' ? 'selected' : ''}>Gesellschaft</option></select><button class="btn-danger" onclick="this.parentElement.remove(); updateTotalPoints()">×</button>`;
            container.appendChild(rowDiv);
            updateTotalPoints();
        }
        function resetBewertung() {
            const rows = document.querySelectorAll('#bewertungContainer .bewertung-row');
            for (let i = 1; i < rows.length; i++) rows[i].remove();
            updateTotalPoints();
        }
        function calculateTotalPoints() {
            return Array.from(document.querySelectorAll('#bewertungContainer .bewertung-row input[type="number"]')).reduce((total, input) => total + (parseInt(input.value) || 0), 0);
        }
        function updateTotalPoints() {
            const total = calculateTotalPoints();
            const totalEl = document.getElementById('totalPoints');
            totalEl.textContent = total;
            totalEl.style.color = total === 100 ? 'var(--zh-success)' : 'var(--zh-danger)';
        }
        function collectBewertungData() {
            const data = [];
            document.querySelectorAll('#bewertungContainer .bewertung-row').forEach((row, index) => {
                if (index === 0) return;
                const inputs = row.querySelectorAll('input, select');
                if (inputs[0].value && inputs[2].value) {
                    data.push({ kriterium: inputs[0].value, kompetenz: inputs[1].value, punkte: parseInt(inputs[2].value) || 0, bereich: inputs[3].value });
                }
            });
            return data;
        }
        function enableManualEdit(step) { const field = document.getElementById({6:'herausforderung',7:'produkt',8:'scaffolds'}[step]); if (field) { field.disabled=false; field.focus(); } }
        function resetField(step) { const field = document.getElementById({6:'herausforderung',7:'produkt',8:'scaffolds'}[step]); if(field){field.value='';field.disabled=false;} }
        function printPreview() { window.print(); }
        function copyToClipboard() { navigator.clipboard.writeText(document.getElementById('previewContent').innerText).then(() => alert('Text kopiert!')); }
        function exportAsJSON() {
            const dataStr = JSON.stringify(appState, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `umsetzungsvariante_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
